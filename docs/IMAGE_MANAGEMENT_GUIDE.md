# 圖片管理完整指南

## 🎯 核心特性

✅ **所有圖片自動轉換為 WebP 格式**
✅ **自動刪除舊圖片，只保留新圖片**
✅ **大幅節省存儲空間（30-80%）**

---

## 📦 安裝依賴

```bash
pip install -r requirements.txt
```

這會安裝 `Pillow==10.1.0` 用於圖片處理。

---

## 🖼️ 自動處理機制

### 1. 上傳新圖片
- 自動轉換為 `.webp` 格式
- 自動壓縮和調整尺寸
- 保持高質量（85-90%）

### 2. 更新/替換圖片
- ✅ **自動刪除舊圖片**
- ✅ 保存新的 WebP 格式圖片
- ✅ 無舊文件殘留

### 3. 刪除記錄
- ✅ **自動刪除相關的物理圖片文件**
- ✅ 防止孤兒文件累積

---

## 🗑️ 清理舊圖片

如果系統中有舊的非 WebP 格式圖片：

### 步驟 1：預覽

```bash
python cleanup_old_images.py --preview
```

這會顯示：
- 找到多少舊格式圖片
- 每個文件的路徑和大小
- 總共可以釋放多少空間

### 步驟 2：清理

```bash
python cleanup_old_images.py --clean
```

輸入 `yes` 確認後，會刪除所有舊格式圖片。

---

## 📊 格式對比

| 原始格式 | 文件大小 | WebP 大小 | 節省 |
|---------|---------|----------|------|
| JPEG | 245 KB | 165 KB | **32.7%** ↓ |
| PNG | 512 KB | 128 KB | **75.0%** ↓ |
| Large Banner | 1024 KB | 716 KB | **30.1%** ↓ |

---

## 🎯 圖片質量設定

| 圖片類型 | 質量 | 最大尺寸 | 用途 |
|---------|------|---------|------|
| 產品圖片 | 85% | 1920×1920 | 產品展示 |
| 店鋪圖片 | 85% | 1920×1920 | 店鋪相簿 |
| 店鋪 Banner | 90% | 2560×1440 | 店鋪橫幅 |
| 首頁 Banner | 90% | 2560×1440 | 首頁輪播 |
| 新聞圖片 | 85% | 1920×1920 | 新聞封面 |

---

## ✅ 自動清理機制

所有這些操作都會**自動刪除舊圖片**：

### 產品管理
- ❌ 刪除產品圖片 → 刪除物理文件

### 店鋪管理
- 🔄 更新店鋪 Banner → 刪除舊 Banner + 保存新 Banner
- ❌ 刪除店鋪 Banner → 刪除物理文件
- ❌ 刪除店鋪圖片 → 刪除物理文件

### 新聞管理
- 🔄 更新新聞圖片 → 刪除舊圖片 + 保存新圖片
- ❌ 刪除新聞 → 刪除物理文件

### 首頁 Banner 管理
- 🔄 更新 Banner 圖片 → 刪除舊圖片 + 保存新圖片
- ❌ 刪除 Banner → 刪除物理文件

---

## 🚀 使用建議

### 開發環境
1. 安裝依賴：`pip install -r requirements.txt`
2. 測試上傳：確認圖片自動轉為 `.webp`
3. 測試更新：確認舊圖片被刪除

### 生產環境部署
1. 安裝 Pillow：`pip install Pillow==10.1.0`
2. 清理舊圖片：
   ```bash
   python cleanup_old_images.py --preview  # 先預覽
   python cleanup_old_images.py --clean    # 再清理
   ```
3. 重啟應用
4. 測試圖片上傳功能

### 定期維護
- 每月運行 `--preview` 檢查是否有遺留舊文件
- 監控 `public/uploads` 目錄大小
- 檢查應用日誌確認轉換正常

---

## 📖 詳細文檔

- **完整清理策略**：`docs/IMAGE_CLEANUP_POLICY.md`
- **Pillow 安裝指南**：`docs/INSTALL_PILLOW.md`
- **技術實現**：`app/utils/image_processor.py`
- **清理工具**：`cleanup_old_images.py`

---

## 🎉 總結

本系統已實現完整的圖片管理機制：

✅ **自動轉換**：所有上傳的圖片自動轉為 WebP  
✅ **自動清理**：更新/刪除時自動刪除舊圖片  
✅ **零殘留**：無孤兒文件，保持系統整潔  
✅ **節省空間**：文件大小減少 30-80%  
✅ **高質量**：保持 85-90% 高質量  

**無需手動管理，系統全自動處理！** 🚀

