# 店主管理後台使用指南

> 本指南說明店主（Store Admin）如何使用管理後台進行店鋪和產品管理

---

## 🏪 店鋪管理

### 頁面結構

店鋪管理採用**獨立頁面設計**（參考 Backend 設計），包含三個主要頁面：

```
/store_admin/shops
├── list.html    - 店鋪列表（搜尋、篩選、操作）
├── add.html     - 新增店鋪（獨立頁面）
└── edit.html    - 編輯店鋪（獨立頁面）
```

### 1️⃣ 店鋪列表（/store_admin/shops）

**功能特色：**
- ✅ 表格顯示所有自己擁有的店鋪
- ✅ 即時搜尋（店鋪名稱、描述）
- ✅ 狀態篩選（營業中/已關閉）
- ✅ 操作按鈕：詳情、編輯、刪除

**表格欄位：**
| 欄位 | 說明 |
|------|------|
| ID | 店鋪唯一識別碼 |
| 店鋪名稱 | 店鋪名稱 + 描述預覽 |
| 訂單ID | 用於訂單編號的商店 ID（藍色徽章） |
| 最大配料 | 每筆訂單可選擇的最大配料數量 |
| 狀態 | 營業中（綠色）/ 已關閉（灰色） |
| 建立時間 | 店鋪建立日期 |
| 操作 | 詳情、編輯、刪除按鈕 |

**空狀態提示：**
```
🏪
您還沒有店鋪，點擊「新增店鋪」開始建立！
```

### 2️⃣ 新增店鋪（/store_admin/shops/add）

**必填欄位：**
- **店鋪名稱** *
- **商店訂單ID** * - 格式：大寫字母和數字，2-20 字符（如：SHOP01, A001）
- **最大配料數量** * - 預設：5 個

**選填欄位：**
- 店鋪描述
- 狀態（預設：營業中）

**驗證規則：**
```
商店訂單ID：
  ✓ 只能包含大寫字母和數字（A-Z, 0-9）
  ✓ 長度：2-20 個字符
  ✓ 不可重複（系統唯一）
  ✓ 自動轉大寫
```

**儲存後：**
- 自動返回店鋪列表
- 可在配料管理中添加配料
- 可在產品管理中添加商品

### 3️⃣ 編輯店鋪（/store_admin/shops/<id>/edit）

**可編輯欄位：**
- 店鋪名稱
- 商店訂單ID（需驗證唯一性）
- 店鋪描述
- 最大配料數量
- 狀態（營業中/已關閉）

**額外功能：**
- 顯示記錄資訊（建立時間、更新時間）
- **刪除店鋪** 按鈕（紅色，右下角）

**刪除確認：**
```
確定要刪除此店鋪嗎？

此操作為軟刪除，可在後台恢復。
```

---

## 📦 產品管理

### 頁面結構

產品管理同樣採用**獨立頁面設計**：

```
/store_admin/products
├── list.html    - 產品列表（搜尋、分類篩選、狀態篩選）
├── add.html     - 新增產品（含飲品選項）
└── edit.html    - 編輯產品（含飲品選項）
```

### 1️⃣ 產品列表（/store_admin/products）

**功能特色：**
- ✅ 表格顯示所有產品
- ✅ 即時搜尋（產品名稱、描述）
- ✅ 分類篩選
- ✅ 狀態篩選（已上架/已下架）
- ✅ 操作按鈕：編輯、刪除、上下架切換

**表格欄位：**
| 欄位 | 說明 |
|------|------|
| ID | 產品唯一識別碼 |
| 產品名稱 | 產品名稱 + 描述預覽 |
| 分類 | 產品所屬分類 |
| 單價 | 基礎售價 |
| 折扣價 | 促銷價格（如有） |
| 庫存 | 庫存數量（綠色/紅色徽章） |
| 飲品 | 🧊（冷飲）☕（熱飲）圖標 |
| 狀態 | 上架（綠色）/ 下架（灰色） |
| 操作 | 編輯、刪除、上下架按鈕 |

**空狀態提示：**
```
📦
還沒有產品，點擊「新增產品」開始建立！
```

### 2️⃣ 新增產品（/store_admin/products/add）

**基本資訊（必填）：**
- **產品名稱** *
- **產品分類** *
- **單價** *（整數）
- **庫存數量** *（預設：0）
- **狀態** *（預設：上架）

**選填資訊：**
- 產品描述
- 折扣價（必須小於單價）

**飲品選項（可選）：**
```
🥤 飲品選項（可選）

☐ 🧊 提供冷飲
    └─ 冷飲加價：$ [  0  ]

☐ ☕ 提供熱飲
    └─ 熱飲加價：$ [  0  ]

說明：若商品提供冷/熱飲選項，請勾選並設定加價
```

**飲品設置邏輯：**
1. 勾選「提供冷飲」→ 顯示冷飲加價輸入框
2. 勾選「提供熱飲」→ 顯示熱飲加價輸入框
3. 加價可設為 0（表示免費升級）
4. 不勾選則不提供該選項

**前台顯示效果：**
```
商品詳情
├── 珍珠奶茶 $50
│
└── 飲品選擇
    ◯ 🧊 冷飲 +$10
    ◯ ☕ 熱飲 +$5
    ◉ 不需要（預設）
```

### 3️⃣ 編輯產品（/store_admin/products/<id>/edit）

**可編輯欄位：**
- 所有基本資訊
- 飲品選項（勾選狀態 + 加價）

**額外功能：**
- 顯示產品 ID
- 顯示記錄資訊（建立時間、更新時間）
- **刪除產品** 按鈕（紅色，右下角）

**刪除確認：**
```
確定要刪除產品「XXX」嗎？

此操作為軟刪除，可在後台恢復。
```

**飲品選項編輯：**
- 可隨時新增或移除飲品選項
- 修改加價金額
- 變更會立即反映在前台

---

## 🔑 權限說明

### 店主（Store Admin）只能：

✅ **店鋪管理**
- 查看 `owner_id = 自己` 的店鋪
- 新增、編輯、刪除自己的店鋪

✅ **產品管理**
- 查看 `shop_id = 自己店鋪` 的產品
- 新增、編輯、刪除自己店鋪的產品

❌ **無法操作**
- 其他店主的店鋪
- 其他店鋪的產品
- 系統設定
- 內容管理

### 管理員（Admin）可以：

✅ 查看和管理所有店鋪和產品（包括已刪除的記錄）

---

## 🗑️ 軟刪除說明

### 什麼是軟刪除？

軟刪除不會真正從數據庫中刪除記錄，而是：
1. 設置 `deleted_at` 時間戳
2. 產品額外設置 `is_active = false`
3. 查詢時自動排除已刪除記錄

### 軟刪除的好處

✅ **可恢復** - 誤刪可找回  
✅ **保留歷史** - 訂單關聯不受影響  
✅ **審計追蹤** - 完整的操作記錄  
✅ **數據完整** - 統計分析更準確  

### 刪除流程

```
點擊「刪除」按鈕
  ↓
確認對話框
  ↓
設置 deleted_at = 現在時間
  ↓
記錄到 update_log
  ↓
前台不再顯示
  ↓
後台管理員可恢復
```

---

## 📋 操作流程示例

### 場景 1：開設新店鋪

```
1. 登入 /store_admin → 自動跳轉到儀表板
2. 點擊側邊欄「店鋪管理」
3. 點擊「新增店鋪」按鈕
4. 填寫資料：
   - 店鋪名稱：「茶飲專賣店」
   - 商店訂單ID：「TEA01」（自動轉大寫）
   - 店鋪描述：「提供各式手作茶飲」
   - 最大配料數量：5
   - 狀態：營業中
5. 點擊「儲存」
6. 返回列表頁，看到新店鋪
```

### 場景 2：新增帶飲品選項的產品

```
1. 點擊側邊欄「產品管理」
2. 點擊「新增產品」按鈕
3. 填寫基本資料：
   - 產品名稱：「珍珠奶茶」
   - 產品分類：「飲品」
   - 單價：50
   - 庫存：100
   
4. 設置飲品選項：
   ☑ 🧊 提供冷飲
      └ 冷飲加價：10
   
   ☑ ☕ 提供熱飲
      └ 熱飲加價：5

5. 點擊「儲存」
6. 前台顧客可選擇：冷飲（+$10）或熱飲（+$5）
```

### 場景 3：編輯產品並修改飲品設定

```
1. 在產品列表點擊「編輯」按鈕
2. 修改單價：50 → 55
3. 修改冷飲加價：10 → 15
4. 點擊「更新」
5. 前台立即反映新價格
```

### 場景 4：軟刪除產品

```
1. 在編輯頁面點擊右下角「刪除產品」
2. 確認對話框：「此操作為軟刪除，可在後台恢復」
3. 點擊確認
4. 產品從列表消失
5. 數據庫中 deleted_at 被設置
6. 前台不再顯示
7. 後台管理員可恢復
```

---

## 🎯 與 Backend 的差異

| 特性 | Backend (Admin) | Shop Admin (店主) |
|------|----------------|------------------|
| **店鋪列表** | 所有店鋪 | 只有自己的店鋪 (`owner_id`) |
| **產品列表** | 所有產品 | 只有自己店鋪的產品 (`shop_id`) |
| **新增店鋪** | 需選擇店主 | 自動為當前用戶 |
| **新增產品** | 需選擇店鋪 | 自動為當前店鋪 |
| **刪除記錄** | 可查看已刪除 | 無法查看已刪除 |
| **恢復功能** | ✅ 可恢復 | ❌ 無法恢復（需找管理員） |

---

## 🛡️ 權限控制機制

### 路由層級

```python
@store_admin_bp.route('/products')
@role_required('store_admin')  # ← 只有 store_admin 可訪問
def products():
    # 只查詢當前用戶的店鋪
    shop = Shop.query.filter_by(owner_id=user.id)
                     .filter(Shop.deleted_at.is_(None))
                     .first_or_404()
```

### API 層級

```python
@products_api_bp.route('/<int:product_id>', methods=['PUT'])
def update_product(product_id):
    product = Product.query.get_or_404(product_id)
    shop = Shop.query.get_or_404(product.shop_id)
    
    # 權限檢查
    if user.role != 'admin' and shop.owner_id != user.id:
        return jsonify({'error': 'forbidden'}), 403
```

### 數據隔離

```
店主 A:
  ├── Shop A (owner_id=A)
  │   ├── Product A1 (shop_id=A)
  │   ├── Product A2 (shop_id=A)
  │   └── Order A1, A2, ...

店主 B:
  ├── Shop B (owner_id=B)
  │   ├── Product B1 (shop_id=B)
  │   └── Order B1, B2, ...

店主 A 無法訪問 Shop B 或 Product B1
```

---

## 📱 UI/UX 設計原則

### 1️⃣ 一致性

**與 Backend 保持一致：**
- 相同的表格樣式
- 相同的按鈕排列
- 相同的表單佈局
- 相同的錯誤提示

### 2️⃣ 簡化操作

**店主不需要：**
- ❌ 選擇店主（自己就是店主）
- ❌ 選擇店鋪（自動鎖定自己的店鋪）
- ❌ 查看其他店鋪（只顯示自己的）

### 3️⃣ 友好提示

**空狀態：**
- 顯示大圖標（🏪 或 📦）
- 清晰的指引文字
- 明確的操作提示

**錯誤訊息：**
- 紅色 Alert 框
- 具體的錯誤原因
- 建議的解決方案

---

## 🎨 飲品選項設計

### 設置界面

```
┌─────────────────────────────────────────┐
│ 🥤 飲品選項（可選）                      │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────┬─────────────┐         │
│  │ ☑ 🧊 提供冷飲 │ ☑ ☕ 提供熱飲 │         │
│  │             │             │         │
│  │ 冷飲加價     │ 熱飲加價     │         │
│  │ $ [  10  ]  │ $ [   5  ]  │         │
│  └─────────────┴─────────────┘         │
│                                         │
│  提示：可設為 0（免費）                  │
└─────────────────────────────────────────┘
```

### 前台顯示

```
商品詳情：珍珠奶茶
├── 基礎價格：$50
│
├── 飲品選擇
│   ◯ 🧊 冷飲 +$10
│   ◯ ☕ 熱飲 +$5
│   ◉ 不需要
│
└── 總價：$60（已選冷飲）
```

---

## 📊 數據流程圖

### 新增產品 → 顧客下單 → 訂單記錄

```
【店主設置】
產品：珍珠奶茶
  ├── 單價：$50
  ├── has_cold_drink: true
  ├── cold_drink_price: 10
  ├── has_hot_drink: true
  └── hot_drink_price: 5

        ↓

【顧客選擇】
商品詳情模態框
  ├── 選擇：🧊 冷飲
  ├── 數量：2
  └── 總價：(50 + 10) × 2 = $120

        ↓

【購物車】
珍珠奶茶 × 2
  ├── 飲品：🧊 冷飲 (+$10)
  └── 小計：$120

        ↓

【訂單記錄】
OrderItem:
  ├── product_id: 1
  ├── quantity: 2
  ├── unit_price: 60
  ├── drink_type: 'cold'  ← 記錄飲品類型
  └── drink_price: 10     ← 記錄飲品價格

        ↓

【訂單詳情】
訂單 #ORDER-A001-20251106-00001
├── 產品：珍珠奶茶 × 2
├── 單價：$60
├── 飲品：🧊 冷飲
└── 小計：$120
```

---

## 🔧 常見操作

### ❓ 如何修改訂單編號格式？

**訂單編號格式：**
```
ORDER-A001-20251106-00001
  │     │      │       │
  │     │      │       └─ 流水號（5位，每日重置）
  │     │      └───────── 日期（YYYYMMDD）
  │     └──────────────── 商店訂單ID（在店鋪管理中設置）
  └────────────────────── 訂單前綴（後台管理員設置）
```

**修改步驟：**
1. 編輯店鋪
2. 修改「商店訂單ID」欄位
3. 範例：TEA01, SHOP02, A001
4. 儲存後，新訂單使用新 ID

### ❓ 如何讓產品提供冷熱飲？

1. 編輯產品
2. 勾選「🧊 提供冷飲」
3. 設定冷飲加價（可為 0）
4. 勾選「☕ 提供熱飲」
5. 設定熱飲加價（可為 0）
6. 儲存

### ❓ 如何恢復已刪除的產品？

店主無法自行恢復，需要聯繫系統管理員：
1. 聯繫管理員
2. 管理員登入 `/backend`
3. 查看已刪除記錄
4. 清除 `deleted_at` 欄位
5. 產品恢復顯示

---

## 📚 相關文檔

- [README.md](../README.md) - 完整的項目說明
- [PERMISSIONS.md](./PERMISSIONS.md) - 權限管理架構
- [CHANGELOG.md](../CHANGELOG.md) - 更新日誌

---

<div align="center">
  <p>🎯 專為店主設計的簡潔管理介面</p>
  <p>💼 參考 Backend 設計，保持一致性</p>
</div>

