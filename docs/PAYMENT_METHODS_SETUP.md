# 支付方式設置指南

## 概述

本系統需要至少一種支付方式才能正常運作。**現金支付是必需的基礎支付方式**，不能被刪除或禁用。

---

## 快速開始

### 1. 初始化現金支付方式

新安裝的系統需要先初始化現金支付方式：

```bash
python init_payment_methods.py
```

**執行結果：**
```
============================================================
初始化支付方式
============================================================

創建現金支付方式...
✓ 現金支付方式創建成功！

目前系統中共有 1 種支付方式：
  • 現金 (cash) - ✓ 啟用 [必需]
============================================================
```

### 2. 驗證支付方式

1. 訪問 Backend 支付方式管理頁面：
   ```
   http://localhost:5000/backend/payment-methods
   ```

2. 應該看到「現金」支付方式已列出
3. 「刪除」按鈕應該是禁用狀態

---

## 添加其他支付方式

### 使用 Backend 管理介面

1. 登入 Backend 管理系統
2. 進入「支付方式管理」
3. 點擊「+ 新增支付方式」
4. 填寫以下資訊：
   - **名稱**：支付方式顯示名稱（如：LINE Pay、街口支付）
   - **代碼**：唯一識別碼（如：line_pay、jko_pay）
   - **圖標**：Font Awesome 圖標類名
   - **顯示順序**：數字越小越靠前（現金固定為 99）
   - **狀態**：啟用/禁用

### 常用支付方式示例

| 名稱 | 代碼 | 圖標 |
|------|------|------|
| LINE Pay | `line_pay` | `fa-brands fa-line` |
| 街口支付 | `jko_pay` | `fa-solid fa-wallet` |
| 信用卡 | `credit_card` | `fa-brands fa-cc-visa` |
| 悠遊卡 | `easycard` | `fa-solid fa-id-card` |

---

## 店家支付方式設置

### 為店鋪啟用支付方式

1. 登入 Store Admin
2. 進入「店鋪管理」→ 選擇店鋪 → 「支付方式設置」
3. 勾選要啟用的支付方式
4. **注意**：現金支付是必需的，無法取消勾選
5. 點擊「儲存設置」

### 支付方式規則

- ✅ 店家可以啟用多種支付方式
- ✅ 顧客可以使用組合支付（如：現金 $50 + LINE Pay $50）
- ✅ 現金支付必須包含在內
- ❌ 不能完全不啟用任何支付方式

---

## 現金支付特殊規則

### 為什麼現金支付是必需的？

1. **系統穩定性**：確保所有店鋪至少有一種可用的支付方式
2. **普遍性**：現金是最基礎、最通用的支付方式
3. **備用方案**：當電子支付出現問題時的後備選項

### 保護機制

**三層防護：**

1. **前端 UI 保護**
   - Backend 管理頁面：刪除按鈕禁用
   - Store Admin 設置頁面：checkbox 禁用 + 「必需」標籤

2. **後端 API 保護**
   - 拒絕刪除現金支付的 DELETE 請求
   - 拒絕禁用現金支付的 PUT 請求
   - 店家設置時強制包含現金支付

3. **業務邏輯保護**
   - 結帳頁面預設選擇現金支付
   - 自動填入應付金額

---

## 常見問題

### Q1：如何重新初始化支付方式？

**A：** 執行初始化腳本是安全的，可以重複執行：

```bash
python init_payment_methods.py
```

腳本會自動檢查現金支付是否已存在，不會重複創建。

### Q2：可以修改現金支付的名稱或圖標嗎？

**A：** 可以。在 Backend 管理頁面編輯現金支付方式，可以修改：
- 名稱（如：「現金」改為「Cash」）
- 圖標
- 顯示順序（建議保持 99）

**不能修改的：**
- 代碼（code='cash'）：系統識別用
- 狀態：必須保持「啟用」

### Q3：為什麼我的店鋪結帳頁面沒有支付方式？

**A：** 可能的原因：

1. **系統沒有初始化支付方式**
   - 解決：執行 `python init_payment_methods.py`

2. **店鋪沒有啟用支付方式**
   - 解決：進入 Store Admin → 支付方式設置 → 勾選要啟用的支付方式

3. **支付方式被禁用**
   - 解決：在 Backend 管理頁面檢查支付方式狀態

### Q4：組合支付如何運作？

**A：** 顧客在結帳時可以選擇多種支付方式組合：

**示例：**
```
訂單總額：$150

選擇支付方式：
☑ LINE Pay：$100
☑ 現金：$50
─────────────
總計：$150 ✓
```

系統會驗證支付總額是否等於訂單金額。

### Q5：如何添加新的電子支付方式？

**A：** 步驟：

1. 在 Backend 管理頁面新增支付方式
2. 設置名稱、代碼、圖標
3. 在 Store Admin 為店鋪啟用該支付方式
4. 顧客即可在結帳時使用

**注意：** 系統只處理支付方式的選擇和記錄，實際的金流串接需要另外實現。

---

## 開發者資訊

### 數據庫結構

**支付方式表（payment_methods）：**
```sql
- id: 主鍵
- name: 名稱
- code: 代碼（唯一）
- icon: 圖標類名
- display_order: 顯示順序
- is_active: 是否啟用
- created_at: 創建時間
```

**店鋪支付方式關聯表（shop_payment_methods）：**
```sql
- id: 主鍵
- shop_id: 店鋪ID
- payment_method_id: 支付方式ID
- is_enabled: 是否啟用
```

### API 端點

**系統級（Admin Only）：**
- `GET /api/payment-methods` - 獲取所有支付方式
- `POST /api/payment-methods` - 創建支付方式
- `PUT /api/payment-methods/<id>` - 更新支付方式
- `DELETE /api/payment-methods/<id>` - 刪除支付方式（現金除外）

**店家級：**
- `GET /api/shops/<shop_id>/payment-methods` - 獲取店鋪支付方式設置
- `PUT /api/shops/<shop_id>/payment-methods` - 更新店鋪支付方式設置

**公開查詢：**
- `GET /api/shops/<shop_id>/payment-methods/public` - 獲取店鋪啟用的支付方式（用於結帳）

---

## 相關文件

- [系統安裝指南](../README.md)
- [店家管理手冊](./SHOP_ADMIN_GUIDE.md)
- [API 文檔](./API_DOCUMENTATION.md)
- [更新日誌](../CHANGELOG.md)

---

**最後更新：** 2025-11-06
**維護者：** Food Stores 開發團隊

