# QRCode 操作指南 - 使用者管理層面

## 📋 目錄

1. [使用者角色權限總覽](#使用者角色權限總覽)
2. [Admin（超級管理員）操作指南](#admin超級管理員操作指南)
3. [Store Admin（店主）操作指南](#store-admin店主操作指南)
4. [Customer（顧客）使用說明](#customer顧客使用說明)
5. [Guest（訪客）使用說明](#guest訪客使用說明)
6. [權限檢查機制](#權限檢查機制)
7. [常見操作場景](#常見操作場景)

---

## 使用者角色權限總覽

### 權限矩陣表

| 功能 | Admin | Store Admin | Customer | Guest |
|------|-------|-------------|----------|-------|
| **啟用/停用 QRCode 功能** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **查看桌號列表** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **創建單個桌號** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **批量創建桌號** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **編輯桌號** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **刪除桌號** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **查看 QRCode 圖片** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **打印 QRCode** | ✅ 所有店鋪 | ✅ 自己的店鋪 | ❌ | ❌ |
| **掃描 QRCode 點餐** | ❌ | ❌ | ❌ | ✅ |
| **查看訂單（含桌號）** | ✅ 所有訂單 | ✅ 自己店鋪的訂單 | ✅ 自己的訂單 | ❌ |

### 權限說明

- **Admin（超級管理員）**：可以管理系統中所有店鋪的 QRCode 和桌號
- **Store Admin（店主）**：只能管理自己擁有店鋪的 QRCode 和桌號
- **Customer（顧客）**：無法管理 QRCode，但可以通過登入帳號正常點餐
- **Guest（訪客）**：只能掃描 QRCode 進行點餐，無需登入

---

## Admin（超級管理員）操作指南

### 登入方式

```
後台管理系統 → 使用 Admin 帳號登入
```

### 可執行的操作

#### 1. 啟用/停用任何店鋪的 QRCode 功能

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 編輯 → 啟用/停用「桌號掃碼點餐」
```

**操作步驟：**
1. 登入後台管理系統
2. 進入「店鋪管理」
3. 選擇要設置的店鋪
4. 點擊「編輯店鋪」
5. 找到「桌號掃碼點餐」選項
6. 勾選/取消勾選「啟用桌號掃碼點餐」
7. 點擊「保存」

**權限說明：**
- ✅ 可以啟用/停用**任何店鋪**的 QRCode 功能
- ✅ 不受 `owner_id` 限制

#### 2. 查看所有店鋪的桌號列表

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理
```

**操作步驟：**
1. 登入後台管理系統
2. 進入「店鋪管理」
3. 選擇要查看的店鋪
4. 點擊「桌號管理」
5. 查看桌號列表（包含桌號、狀態、QRCode 預覽）

**權限說明：**
- ✅ 可以查看**任何店鋪**的桌號列表
- ✅ 不受 `owner_id` 限制

#### 3. 為任何店鋪創建桌號

**單個創建：**

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理 → 新增桌號
```

**操作步驟：**
1. 進入桌號管理頁面
2. 點擊「新增桌號」按鈕
3. 輸入桌號（如：A1、B2、01、02）
4. 點擊「創建」
5. 系統自動生成 QRCode 圖片

**批量創建：**

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理 → 批量創建
```

**操作步驟：**
1. 進入桌號管理頁面
2. 點擊「批量創建」按鈕
3. 設置參數：
   - **數量**：要創建的桌號數量（1-100）
   - **前綴**（可選）：如 A、B、VIP
   - **起始編號**：從哪個數字開始
4. 點擊「批量創建」
5. 系統自動為每個桌號生成 QRCode

**權限說明：**
- ✅ 可以為**任何店鋪**創建桌號
- ✅ 系統會自動生成 QRCode 圖片
- ✅ 不受 `owner_id` 限制

#### 4. 編輯任何店鋪的桌號

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理 → 編輯桌號
```

**操作步驟：**
1. 進入桌號管理頁面
2. 找到要編輯的桌號
3. 點擊「編輯」按鈕
4. 修改桌號編號或狀態
5. 點擊「保存」
6. 如果修改了桌號編號，系統會自動重新生成 QRCode

**權限說明：**
- ✅ 可以編輯**任何店鋪**的桌號
- ✅ 更新桌號編號時會自動重新生成 QRCode
- ✅ 不受 `owner_id` 限制

#### 5. 刪除任何店鋪的桌號

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理 → 刪除桌號
```

**操作步驟：**
1. 進入桌號管理頁面
2. 找到要刪除的桌號
3. 點擊「刪除」按鈕
4. 確認刪除
5. 系統會自動刪除對應的 QRCode 文件

**權限說明：**
- ✅ 可以刪除**任何店鋪**的桌號
- ✅ 刪除時會自動刪除對應的 QRCode 文件
- ✅ 不受 `owner_id` 限制

#### 6. 查看和打印任何店鋪的 QRCode

**查看 QRCode：**

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理 → 查看 QRCode
```

**操作步驟：**
1. 進入桌號管理頁面
2. 找到要查看的桌號
3. 點擊「查看」按鈕
4. QRCode 圖片會在新視窗中打開

**打印 QRCode：**

**操作路徑：**
```
後台管理 → 店鋪管理 → 選擇店鋪 → 桌號管理 → 打印所有 QRCode
```

**操作步驟：**
1. 進入桌號管理頁面
2. 點擊「打印所有 QRCode」按鈕
3. 系統會生成打印友好頁面
4. 每頁顯示 4 個 QRCode（2x2 網格）
5. 每個 QRCode 顯示：店名 + 桌號 + 掃碼說明
6. 使用瀏覽器打印功能打印

**權限說明：**
- ✅ 可以查看和打印**任何店鋪**的 QRCode
- ✅ 不受 `owner_id` 限制

### Admin 操作注意事項

1. **權限範圍**
   - Admin 擁有最高權限，可以管理所有店鋪的 QRCode
   - 建議在操作前確認店鋪信息，避免誤操作

2. **批量操作**
   - 批量創建桌號時，建議先與店主確認需求
   - 注意檢查店鋪的 `max_tables` 限制

3. **數據安全**
   - 刪除桌號前請確認是否還有未完成的訂單
   - 建議定期備份 QRCode 圖片文件

---

## Store Admin（店主）操作指南

### 登入方式

```
店鋪管理系統 → 使用 Store Admin 帳號登入
```

### 可執行的操作

#### 1. 啟用/停用自己店鋪的 QRCode 功能

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 編輯店鋪 → 啟用/停用「桌號掃碼點餐」
```

**操作步驟：**
1. 登入店鋪管理系統
2. 進入「我的店鋪」
3. 選擇要設置的店鋪
4. 點擊「編輯店鋪」
5. 找到「桌號掃碼點餐」選項
6. 勾選/取消勾選「啟用桌號掃碼點餐」
7. 點擊「保存」

**API 操作：**
```bash
PUT /api/shops/:shop_id
Authorization: Bearer {store_admin_token}
Content-Type: application/json

{
  "qrcode_enabled": true
}
```

**權限檢查：**
- ✅ 只能啟用/停用**自己擁有**的店鋪（`shop.owner_id == user.id`）
- ❌ 無法修改其他店主的店鋪設置

#### 2. 查看自己店鋪的桌號列表

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理
```

**操作步驟：**
1. 登入店鋪管理系統
2. 進入「我的店鋪」
3. 選擇要查看的店鋪
4. 點擊「桌號管理」
5. 查看桌號列表（包含桌號、狀態、QRCode 預覽）

**權限檢查：**
- ✅ 只能查看**自己擁有**店鋪的桌號
- ❌ 無法查看其他店主的桌號

#### 3. 為自己店鋪創建桌號

**單個創建：**

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理 → 新增桌號
```

**操作步驟：**
1. 進入桌號管理頁面
2. 點擊「新增桌號」按鈕
3. 輸入桌號（如：A1、B2、01、02）
4. 點擊「創建」
5. 系統自動生成 QRCode 圖片

**批量創建：**

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理 → 批量創建
```

**操作步驟：**
1. 進入桌號管理頁面
2. 點擊「批量創建」按鈕
3. 設置參數：
   - **數量**：要創建的桌號數量（1-100）
   - **前綴**（可選）：如 A、B、VIP
   - **起始編號**：從哪個數字開始
4. 點擊「批量創建」
5. 系統自動為每個桌號生成 QRCode

**權限檢查：**
- ✅ 只能為**自己擁有**的店鋪創建桌號（`shop.owner_id == user.id`）
- ❌ 無法為其他店主的店鋪創建桌號
- ⚠️ 注意檢查店鋪的 `max_tables` 限制

#### 4. 編輯自己店鋪的桌號

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理 → 編輯桌號
```

**操作步驟：**
1. 進入桌號管理頁面
2. 找到要編輯的桌號
3. 點擊「編輯」按鈕
4. 修改桌號編號或狀態
5. 點擊「保存」
6. 如果修改了桌號編號，系統會自動重新生成 QRCode

**權限檢查：**
- ✅ 只能編輯**自己擁有**店鋪的桌號（`shop.owner_id == user.id`）
- ❌ 無法編輯其他店主的桌號

#### 5. 刪除自己店鋪的桌號

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理 → 刪除桌號
```

**操作步驟：**
1. 進入桌號管理頁面
2. 找到要刪除的桌號
3. 點擊「刪除」按鈕
4. 確認刪除
5. 系統會自動刪除對應的 QRCode 文件

**權限檢查：**
- ✅ 只能刪除**自己擁有**店鋪的桌號（`shop.owner_id == user.id`）
- ❌ 無法刪除其他店主的桌號

#### 6. 查看和打印自己店鋪的 QRCode

**查看 QRCode：**

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理 → 查看 QRCode
```

**操作步驟：**
1. 進入桌號管理頁面
2. 找到要查看的桌號
3. 點擊「查看」按鈕
4. QRCode 圖片會在新視窗中打開

**打印 QRCode：**

**操作路徑：**
```
店鋪管理 → 我的店鋪 → 選擇店鋪 → 桌號管理 → 打印所有 QRCode
```

**操作步驟：**
1. 進入桌號管理頁面
2. 點擊「打印所有 QRCode」按鈕
3. 系統會生成打印友好頁面
4. 每頁顯示 4 個 QRCode（2x2 網格）
5. 每個 QRCode 顯示：店名 + 桌號 + 掃碼說明
6. 使用瀏覽器打印功能打印

**權限檢查：**
- ✅ 只能查看和打印**自己擁有**店鋪的 QRCode（`shop.owner_id == user.id`）
- ❌ 無法查看其他店主的 QRCode

### Store Admin 操作注意事項

1. **權限限制**
   - Store Admin 只能管理自己擁有店鋪的 QRCode
   - 如果嘗試訪問其他店主的店鋪，系統會返回 403 錯誤

2. **桌號數量限制**
   - 注意檢查店鋪的 `max_tables` 設置
   - 批量創建時不要超過限制

3. **QRCode 管理**
   - 建議定期檢查 QRCode 圖片是否正常生成
   - 打印 QRCode 後建議測試掃描是否正常

4. **桌號狀態管理**
   - 定期更新桌號狀態（available/occupied/cleaning）
   - 方便追蹤桌號使用情況

---

## Customer（顧客）使用說明

### 登入方式

```
前台網站 → 登入/註冊 → 使用 Customer 帳號登入
```

### 權限說明

**Customer 角色無法管理 QRCode**，但可以：
- ✅ 瀏覽所有公開的店鋪和產品
- ✅ 通過登入帳號正常點餐
- ✅ 查看自己的訂單歷史
- ✅ 使用回饋金功能

### 使用 QRCode 點餐（作為訪客）

雖然 Customer 角色無法管理 QRCode，但可以**作為訪客**掃描 QRCode 進行點餐：

1. **掃描 QRCode**
   - 使用手機掃描桌上的 QRCode
   - 無需登入即可進入點餐頁面

2. **點餐流程**
   - 瀏覽商品
   - 加入購物車
   - 結帳下單

3. **訂單追蹤**
   - 如果未登入，無法查看訂單歷史
   - 建議登入後再掃描 QRCode，以便追蹤訂單

### Customer 注意事項

1. **登入建議**
   - 雖然可以作為訪客點餐，但建議登入後再掃描 QRCode
   - 登入後可以查看訂單歷史和使用回饋金

2. **無法管理 QRCode**
   - Customer 角色無法訪問桌號管理功能
   - 如果嘗試訪問，系統會返回 403 錯誤

---

## Guest（訪客）使用說明

### 使用方式

**無需登入**，直接掃描 QRCode 即可點餐。

### 完整使用流程

#### 步驟 1: 掃描 QRCode

使用手機相機或掃碼 APP 掃描桌上的 QRCode。

**QRCode 包含的 URL：**
```
https://your-domain.com/guest/shop/{shop_id}/table/{table_number}
```

**範例：**
```
https://quick-foods.ai-tracks.com/guest/shop/1/table/A1
```

#### 步驟 2: 自動進入點餐頁面

掃描後會自動跳轉到點餐頁面，系統會：
- ✅ 檢查店鋪是否啟用 QRCode 功能
- ✅ 檢查桌號是否存在
- ✅ 自動更新桌號狀態（available → occupied）

#### 步驟 3: 瀏覽商品和點餐

**頁面功能：**
- 顯示店鋪名稱和桌號
- 顯示所有可用商品（按分類）
- 商品篩選（按分類）
- 加入購物車功能

**購物車儲存：**
- 使用瀏覽器的 localStorage
- 鍵名：`guest_cart_{shop_id}_{table_number}`
- 清除瀏覽器數據會丟失購物車內容

#### 步驟 4: 查看購物車

**路由：**
```
/guest/shop/:shop_id/table/:table_number/cart
```

**功能：**
- 顯示購物車中的所有商品
- 修改數量、刪除商品
- 顯示總金額
- 前往結帳按鈕

#### 步驟 5: 結帳

**路由：**
```
/guest/shop/:shop_id/table/:table_number/checkout
```

**功能：**
- 顯示訂單摘要
- 選擇支付方式
- 填寫收件人信息（外送時）
- 提交訂單

#### 步驟 6: 訂單成功

**路由：**
```
/guest/shop/:shop_id/table/:table_number/order-success
```

**顯示內容：**
- 訂單成功訊息
- 訂單編號
- 預計送達時間（外送時）

### Guest 使用注意事項

1. **無需登入**
   - 訪客無需註冊或登入即可點餐
   - 購物車數據儲存在瀏覽器 localStorage

2. **訂單追蹤**
   - 未登入的訪客無法查看訂單歷史
   - 建議保存訂單編號以便查詢

3. **瀏覽器數據**
   - 清除瀏覽器數據會丟失購物車內容
   - 建議在結帳前不要清除瀏覽器數據

4. **無法管理 QRCode**
   - 訪客無法訪問任何管理功能
   - 只能使用 QRCode 進行點餐

---

## 權限檢查機制

### 權限檢查原則

系統採用基於角色的存取控制（RBAC），確保不同角色的使用者只能存取和修改自己權限範圍內的資源。

### 權限檢查流程

```
用戶請求
    ↓
檢查登入狀態 (@login_required)
    ↓
檢查角色權限 (@role_required)
    ↓
Admin？
    ├─ 是 → 允許訪問所有店鋪
    └─ 否 → 檢查是否為 Store Admin
            ├─ 是 → 檢查 shop.owner_id == user.id
            │        ├─ 是 → 允許訪問
            │        └─ 否 → 返回 403 錯誤
            └─ 否 → 返回 403 錯誤
```

### 權限錯誤處理

當使用者嘗試執行超出權限範圍的操作時，系統會：

- **未登入**：系統會提示「未認證，请先登录」，並重定向到登入頁面
- **權限不足**：系統會提示「無權訪問此店鋪」或「權限不足」，並拒絕操作

---

## 常見操作場景

### 場景 1: 店主首次設置 QRCode 功能

**操作者：** Store Admin（店主）

**操作步驟：**
1. 登入店鋪管理系統
2. 進入「我的店鋪」→「編輯店鋪」
3. 啟用「桌號掃碼點餐」功能
4. 保存設置
5. 進入「桌號管理」
6. 批量創建桌號（如：20 個，前綴 A，編號 1-20）
7. 點擊「打印所有 QRCode」
8. 打印 QRCode 並貼在桌上

**所需權限：**
- ✅ Store Admin 角色
- ✅ 店鋪所有者（`shop.owner_id == user.id`）

### 場景 2: Admin 協助店主設置 QRCode

**操作者：** Admin（超級管理員）

**操作步驟：**
1. Admin 登入後台管理系統
2. 進入「店鋪管理」→ 選擇店鋪
3. 編輯店鋪，啟用「桌號掃碼點餐」
4. 進入「桌號管理」
5. 批量創建桌號
6. 打印 QRCode

**所需權限：**
- ✅ Admin 角色
- ✅ 無需檢查 `owner_id`（Admin 可以管理所有店鋪）

### 場景 3: 顧客掃描 QRCode 點餐

**操作者：** Guest（訪客）

**操作步驟：**
1. 使用手機掃描桌上的 QRCode
2. 自動進入點餐頁面
3. 瀏覽商品，加入購物車
4. 查看購物車
5. 結帳下單
6. 查看訂單成功頁面

**所需權限：**
- ✅ 無需登入（公開訪問）
- ✅ 店鋪必須啟用 QRCode 功能（`shop.qrcode_enabled == true`）

### 場景 4: 店主更新桌號編號

**操作者：** Store Admin（店主）

**操作步驟：**
1. 登入店鋪管理系統
2. 進入「我的店鋪」→「桌號管理」
3. 找到要更新的桌號
4. 點擊「編輯」
5. 修改桌號編號（如：A1 → B1）
6. 保存
7. 系統自動重新生成 QRCode

**所需權限：**
- ✅ Store Admin 角色
- ✅ 店鋪所有者（`shop.owner_id == user.id`）

### 場景 5: 店主刪除不需要的桌號

**操作者：** Store Admin（店主）

**操作步驟：**
1. 登入店鋪管理系統
2. 進入「我的店鋪」→「桌號管理」
3. 找到要刪除的桌號
4. 點擊「刪除」
5. 確認刪除
6. 系統自動刪除 QRCode 文件

**所需權限：**
- ✅ Store Admin 角色
- ✅ 店鋪所有者（`shop.owner_id == user.id`）

**注意事項：**
- 刪除前確認是否有未完成的訂單
- 刪除後 QRCode 文件也會被刪除

---

## 權限錯誤處理範例

### 錯誤 1: Store Admin 嘗試訪問其他店主的店鋪

**情況：**
- Store Admin 嘗試訪問其他店主的店鋪桌號管理頁面

**系統處理：**
- 顯示錯誤訊息：「無權訪問此店鋪」
- 拒絕訪問，無法查看或操作該店鋪的桌號

### 錯誤 2: Customer 嘗試訪問桌號管理

**情況：**
- Customer 角色嘗試訪問桌號管理功能

**系統處理：**
- 顯示錯誤訊息：「權限不足」
- 拒絕訪問，Customer 無法使用桌號管理功能

### 錯誤 3: 未登入用戶嘗試訪問桌號管理

**情況：**
- 未登入的用戶嘗試訪問桌號管理頁面

**系統處理：**
- 顯示錯誤訊息：「未認證，请先登录」
- 重定向到登入頁面

---

## 總結

### 權限要點

1. **Admin（超級管理員）**
   - ✅ 可以管理所有店鋪的 QRCode
   - ✅ 不受 `owner_id` 限制

2. **Store Admin（店主）**
   - ✅ 只能管理自己擁有店鋪的 QRCode
   - ✅ 必須滿足 `shop.owner_id == user.id`

3. **Customer（顧客）**
   - ❌ 無法管理 QRCode
   - ✅ 可以作為訪客掃描 QRCode 點餐

4. **Guest（訪客）**
   - ❌ 無法管理 QRCode
   - ✅ 可以掃描 QRCode 點餐（無需登入）

### 最佳實踐

1. **權限檢查**
   - 所有管理操作都必須通過權限檢查
   - Store Admin 只能管理自己的店鋪

2. **QRCode 管理**
   - 定期檢查 QRCode 圖片是否正常生成
   - 打印前測試掃描是否正常

3. **桌號管理**
   - 定期更新桌號狀態
   - 刪除前確認是否有未完成的訂單

4. **安全性**
   - 使用 HTTPS 保護 QRCode URL
   - 定期檢查權限設置

---

**最後更新：** 2025-01-27 08:40:22 UTC+8  
**維護者：** 快點訂 開發團隊

