{% extends "base/guest_base.html" %}

{% block extra_css %}
{{ super() }}
<style>
.container .card {
    margin-bottom: 5px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-credit-card me-2"></i>結帳
            </h2>
            <div class="alert alert-info">
                <i class="bi bi-table me-2"></i>桌號：<strong>{{ table_number }}</strong>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- 左側：訂單信息 -->
        <div class="col-lg-8">
            <!-- 桌號信息 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-table me-2"></i>用餐信息</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="customer_name" class="form-label">姓名（選填）</label>
                            <input type="text" class="form-control" id="customer_name" placeholder="請輸入您的姓名">
                        </div>
                        <div class="col-md-6">
                            <label for="customer_phone" class="form-label">聯絡電話（選填）</label>
                            <input type="tel" class="form-control" id="customer_phone" placeholder="請輸入聯絡電話">
                        </div>
                        <div class="col-12">
                            <label for="order_note" class="form-label">備註</label>
                            <textarea class="form-control" id="order_note" rows="2" placeholder="如有特殊需求，請在此填寫..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 購物車商品 -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bag-check me-2"></i>訂單商品</h5>
                </div>
                <div class="card-body" id="orderItems">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 支付方式 -->
            <div class="card shadow-sm mb-4">
                <div class="card-body pt-4 pb-4">
                    <h5 class="mb-4 ps-2"><i class="bi bi-wallet2 me-2"></i>選擇支付方式</h5>
                    
                    <div id="paymentMethodsList" class="mb-4">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2 text-muted">載入支付方式...</span>
                        </div>
                    </div>
                    
                    <div class="border-top pt-4 mt-2">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">訂單總額</span>
                            <span class="fw-bold fs-5">$<span id="orderTotalCalc">0</span></span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center p-3 bg-primary bg-opacity-10 rounded">
                            <strong class="text-primary">應付金額</strong>
                            <strong class="text-primary fs-4">$<span id="orderTotalCalc2">0</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右側：訂單摘要 -->
        <div class="col-lg-4">
            <div class="card shadow-sm" style="position: sticky; top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>訂單摘要</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>商品總計</span>
                        <span id="itemsCount">0 件</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>小計</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <h5 class="mb-0">應付金額</h5>
                        <h5 class="mb-0 text-primary" id="orderTotal">$0</h5>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg mb-3" onclick="submitOrder()">
                        <i class="bi bi-check-circle me-2"></i>確認訂單
                    </button>
                    <a href="{{ url_for('guest.cart', shop_id=shop.id, table_number=table_number) }}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-left me-2"></i>返回購物車
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
const SHOP_ID = {{ shop.id }};
const TABLE_NUMBER = '{{ table_number }}';
const CART_KEY = `guestCart_${SHOP_ID}_${TABLE_NUMBER}`;
let cartData = [];
let paymentMethods = [];

$(document).ready(function() {
    loadCheckoutData();
});

// 載入購物車數據
function loadCheckoutData() {
    cartData = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    
    if (cartData.length === 0) {
        alert('購物車是空的');
        window.location.href = `/guest/shop/${SHOP_ID}/table/${TABLE_NUMBER}/cart`;
        return;
    }
    
    loadPaymentMethods();
    displayOrderItems();
    updateOrderSummary();
}

// 載入店鋪支付方式
function loadPaymentMethods() {
    $.get(`/api/shops/${SHOP_ID}/payment-methods/public`, function(data) {
        paymentMethods = data.payment_methods;
        renderPaymentMethods();
    }).fail(function() {
        $('#paymentMethodsList').html('<p class="text-danger">載入支付方式失敗</p>');
    });
}

// 渲染支付方式（單選）
function renderPaymentMethods() {
    const container = $('#paymentMethodsList');
    container.empty();
    
    if (paymentMethods.length === 0) {
        container.html('<p class="text-muted text-center py-3">此店鋪未設置支付方式</p>');
        return;
    }
    
    paymentMethods.forEach(method => {
        const html = `
            <div class="payment-method-item mb-3 ps-2">
                <label class="d-flex align-items-center p-3 border rounded-3 bg-light bg-opacity-50" for="pm_${method.id}" style="cursor: pointer; margin-bottom: 0;">
                    <input class="form-check-input payment-radio me-2" 
                           type="radio" 
                           name="paymentMethod"
                           id="pm_${method.id}"
                           value="${method.id}"
                           data-code="${method.code}"
                           style="width: 1.2em; height: 1.2em; margin-top: 0;">
                    <i class="${method.icon} me-3 fs-4 text-primary"></i>
                    <strong class="fs-5">${method.name}</strong>
                </label>
            </div>
        `;
        container.append(html);
    });
    
    // 自動選擇預設支付方式（現金優先）
    setTimeout(() => {
        let defaultMethod = null;
        
        if (paymentMethods.length === 1) {
            defaultMethod = paymentMethods[0];
        } else {
            defaultMethod = paymentMethods.find(m => m.code === 'cash');
            if (!defaultMethod && paymentMethods.length > 0) {
                defaultMethod = paymentMethods[0];
            }
        }
        
        if (defaultMethod) {
            $(`#pm_${defaultMethod.id}`).prop('checked', true);
        }
    }, 100);
}

// 顯示訂單商品
function displayOrderItems() {
    const container = document.getElementById('orderItems');
    let html = '';
    
    cartData.forEach(item => {
        let toppingsHtml = '';
        if (item.toppings && item.toppings.length > 0) {
            const toppingNames = item.toppings.map(t => {
                return t.price > 0 ? `${t.name} (+$${t.price})` : `${t.name} (FREE)`;
            }).join('、');
            toppingsHtml = `<small class="text-muted d-block">配料：${toppingNames}</small>`;
        }
        
        let drinkHtml = '';
        if (item.drink_type) {
            const drinkIcon = item.drink_type === 'cold' 
                ? '<i class="fa-solid fa-snowflake text-info"></i>' 
                : '<i class="fa-solid fa-mug-hot text-warning"></i>';
            const drinkName = item.drink_type === 'cold' ? '冷飲' : '熱飲';
            const drinkPriceText = item.drink_price > 0 ? ` (+$${item.drink_price})` : '';
            drinkHtml = `<small class="text-muted d-block">${drinkIcon} ${drinkName}${drinkPriceText}</small>`;
        }
        
        const itemTotal = item.unit_price * item.quantity;
        const itemIndex = cartData.indexOf(item);
        
        html += `
            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${item.product_name}</h6>
                    ${toppingsHtml}
                    ${drinkHtml}
                    <small class="text-muted">單價：$${item.unit_price} × ${item.quantity}</small>
                </div>
                <div class="text-end d-flex flex-column align-items-end">
                    <strong class="text-primary mb-2">$${itemTotal.toFixed(2)}</strong>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeItemFromCheckout(${itemIndex})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 更新訂單摘要
function updateOrderSummary() {
    let total = 0;
    cartData.forEach(item => {
        total += item.unit_price * item.quantity;
    });
    
    document.getElementById('itemsCount').textContent = cartData.length + ' 件';
    document.getElementById('subtotal').textContent = '$' + total.toFixed(2);
    document.getElementById('orderTotal').textContent = '$' + total.toFixed(2);
    document.getElementById('orderTotalCalc').textContent = total.toFixed(2);
    document.getElementById('orderTotalCalc2').textContent = total.toFixed(2);
}

// 從結帳頁面移除商品
function removeItemFromCheckout(index) {
    if (!confirm('確定要移除此商品嗎？')) {
        return;
    }
    
    // 從 localStorage 移除
    cartData.splice(index, 1);
    localStorage.setItem(CART_KEY, JSON.stringify(cartData));
    
    // 檢查購物車是否為空
    if (cartData.length === 0) {
        alert('購物車已清空');
        window.location.href = `/guest/shop/${SHOP_ID}/table/${TABLE_NUMBER}/cart`;
        return;
    }
    
    // 重新顯示
    displayOrderItems();
    updateOrderSummary();
    updateCartCount();
}

// 提交訂單
async function submitOrder() {
    // 驗證支付方式（單選）
    const selectedPayment = $('input[name="paymentMethod"]:checked');
    if (selectedPayment.length === 0) {
        alert('請選擇支付方式');
        return;
    }
    
    const paymentMethodId = parseInt(selectedPayment.val());
    const total = parseFloat($('#orderTotalCalc').text()) || 0;
    
    const customer_name = document.getElementById('customer_name').value.trim();
    const customer_phone = document.getElementById('customer_phone').value.trim();
    const order_note = document.getElementById('order_note').value.trim();
    
    // 準備訂單項目
    const items = cartData.map(item => ({
        product_id: item.product_id,
        quantity: item.quantity,
        drink_type: item.drink_type,
        toppings: item.toppings ? item.toppings.map(t => t.id) : []
    }));
    
    // 單一支付方式
    const paymentSplits = [{
        payment_method_id: paymentMethodId,
        amount: total
    }];
    
    // 使用訪客結帳 API
    try {
        const response = await fetch('/api/orders/guest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                shop_id: SHOP_ID,
                table_number: TABLE_NUMBER,
                items: items,
                payment_splits: paymentSplits,
                customer_name: customer_name || null,
                customer_phone: customer_phone || null,
                note: order_note || null
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            alert('建立訂單失敗: ' + (error.error || '未知錯誤'));
            return;
        }
        
        const result = await response.json();
        
        // 清空購物車
        localStorage.removeItem(CART_KEY);
        updateCartCount();
        
        // 跳轉到訂單成功頁面
        const params = new URLSearchParams({
            order_number: result.order_number,
            amount_paid: result.amount_paid,
            table_number: TABLE_NUMBER,
            shop_id: SHOP_ID
        });
        window.location.href = `/guest/shop/${SHOP_ID}/table/${TABLE_NUMBER}/order-success?${params.toString()}`;
        
    } catch (error) {
        console.error('提交訂單失敗:', error);
        alert('提交訂單失敗，請重試');
    }
}

// 頁面載入時載入數據
loadCheckoutData();
</script>
{% endblock %}

