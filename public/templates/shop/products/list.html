{% extends "base/shop_base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">ç”¢å“ç®¡ç†</h1>
        <a href="{{ url_for('store_admin.product_add') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>æ–°å¢ç”¢å“
        </a>
    </div>
    
    <!-- æœç´¢å’Œç­›é€‰ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="æœå°‹ç”¢å“åç¨±..." onkeyup="performSearch()">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="shopFilter" onchange="performSearch()">
                        <option value="">æ‰€æœ‰åº—é‹ª</option>
                        {% for shop in shops %}
                        <option value="{{ shop.id }}">{{ shop.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="categoryFilter" onchange="performSearch()">
                        <option value="">æ‰€æœ‰åˆ†é¡</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter" onchange="performSearch()">
                        <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                        <option value="active">ä¸Šæ¶</option>
                        <option value="inactive">ä¸‹æ¶</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="stockFilter" onchange="performSearch()">
                        <option value="">æ‰€æœ‰åº«å­˜</option>
                        <option value="in">æœ‰åº«å­˜</option>
                        <option value="out">ç¼ºè²¨</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <select class="form-select" id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                        <option value="10">10 ç­†/é </option>
                        <option value="25">25 ç­†/é </option>
                        <option value="50">50 ç­†/é </option>
                        <option value="100">100 ç­†/é </option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¡¨æ ¼ -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ç”¢å“åç¨±</th>
                            <th>åº—é‹ª</th>
                            <th>åˆ†é¡</th>
                            <th>åƒ¹æ ¼</th>
                            <th>åº«å­˜</th>
                            <th>é£²å“</th>
                            <th>ç‹€æ…‹</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr><td colspan="9" class="text-center">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="paginationInfo"></div>
                <nav>
                    <ul class="pagination mb-0" id="paginationControls"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/backend_common.js') }}"></script>
<script>
let allProducts = {{ products|tojson }};
let allShops = {{ shops|tojson }};
let allCategories = {{ categories|tojson }};

// æ¸²æŸ“äº§å“è¡Œ
function renderProductRow(product) {
    const shop = allShops.find(s => s.id === product.shop_id);
    const shopName = shop ? shop.name : '-';
    
    const category = allCategories.find(c => c.id === product.category_id);
    const categoryName = category ? category.name : '-';
    
    const price = product.discounted_price || product.unit_price;
    const priceHtml = product.discounted_price 
        ? `<span class="text-decoration-line-through text-muted">$${product.unit_price}</span> <span class="text-danger">$${product.discounted_price}</span>`
        : `$${product.unit_price}`;
    
    const stockBadge = product.stock > 0 
        ? `<span class="badge bg-success">${product.stock}</span>` 
        : '<span class="badge bg-danger">ç¼ºè²¨</span>';
    
    // é£²å“åœ–æ¨™
    let drinkBadges = '';
    if (product.has_cold_drink) drinkBadges += '<span class="badge bg-info">ğŸ§Š</span> ';
    if (product.has_hot_drink) drinkBadges += '<span class="badge bg-warning">â˜•</span>';
    if (!drinkBadges) drinkBadges = '<span class="text-muted">-</span>';
    
    const statusBadge = product.is_active 
        ? '<span class="badge bg-success">ä¸Šæ¶</span>' 
        : '<span class="badge bg-secondary">ä¸‹æ¶</span>';
    
    return `
        <tr>
            <td>${product.id}</td>
            <td>
                <strong>${product.name}</strong>
            </td>
            <td>${shopName}</td>
            <td>${categoryName}</td>
            <td>${priceHtml}</td>
            <td>${stockBadge}</td>
            <td>${drinkBadges}</td>
            <td>${statusBadge}</td>
            <td class="text-end">
                <a href="/shop/products/${product.id}/edit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> ç·¨è¼¯
                </a>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                    <i class="bi bi-trash"></i> åˆªé™¤
                </button>
            </td>
        </tr>
    `;
}

// æ¸²æŸ“è¡¨æ ¼
function renderProductsTable() {
    renderTable('productsTableBody', renderProductRow);
}

// æœç´¢
function performSearch() {
    const searchValue = document.getElementById('searchInput').value;
    const shopFilter = document.getElementById('shopFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    
    filteredItems = allProducts.filter(product => {
        const matchSearch = !searchValue || 
            product.name.toLowerCase().includes(searchValue.toLowerCase());
        
        const matchShop = !shopFilter || product.shop_id == shopFilter;
        const matchCategory = !categoryFilter || product.category_id == categoryFilter;
        const matchStatus = !statusFilter || 
            (statusFilter === 'active' && product.is_active) ||
            (statusFilter === 'inactive' && !product.is_active);
        const matchStock = !stockFilter ||
            (stockFilter === 'in' && product.stock > 0) ||
            (stockFilter === 'out' && product.stock === 0);
        
        return matchSearch && matchShop && matchCategory && matchStatus && matchStock;
    });
    
    currentPage = 1;
    renderProductsTable();
    updatePagination();
}

// åˆ é™¤äº§å“
function deleteProduct(productId) {
    confirmDelete('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“å—ï¼Ÿ', function() {
        $.ajax({
            url: '/api/products/' + productId,
            method: 'DELETE',
            success: function() {
                showSuccess('åˆªé™¤æˆåŠŸ');
            },
            error: function() {
                showError('åˆªé™¤å¤±æ•—');
            }
        });
    });
}

// åˆå§‹åŒ–
$(document).ready(function() {
    window.currentRenderFunction = renderProductsTable;
    initializeDataTable('productsTableBody', allProducts, renderProductRow);
});
</script>
{% endblock %}
