{% extends "base/shop_base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">產品管理</h1>
        <a href="{{ url_for('store_admin.product_add') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>新增產品
        </a>
    </div>
    
    <!-- 搜索和筛选 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="搜尋產品名稱..." onkeyup="performSearch()">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="shopFilter" onchange="performSearch()">
                        <option value="">所有店鋪</option>
                        {% for shop in shops %}
                        <option value="{{ shop.id }}">{{ shop.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="categoryFilter" onchange="performSearch()">
                        <option value="">所有分類</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter" onchange="performSearch()">
                        <option value="">所有狀態</option>
                        <option value="active">上架</option>
                        <option value="inactive">下架</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="stockFilter" onchange="performSearch()">
                        <option value="">所有庫存</option>
                        <option value="in">有庫存</option>
                        <option value="out">缺貨</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <select class="form-select" id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                        <option value="10">10 筆/頁</option>
                        <option value="25">25 筆/頁</option>
                        <option value="50">50 筆/頁</option>
                        <option value="100">100 筆/頁</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 表格 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>產品名稱</th>
                            <th>店鋪</th>
                            <th>分類</th>
                            <th>價格</th>
                            <th>庫存</th>
                            <th>飲品</th>
                            <th>狀態</th>
                            <th class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr><td colspan="9" class="text-center">載入中...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="paginationInfo"></div>
                <nav>
                    <ul class="pagination mb-0" id="paginationControls"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/backend_common.js') }}"></script>
<script>
let allProducts = {{ products|tojson }};
let allShops = {{ shops|tojson }};
let allCategories = {{ categories|tojson }};

// 渲染产品行
function renderProductRow(product) {
    const shop = allShops.find(s => s.id === product.shop_id);
    const shopName = shop ? shop.name : '-';
    
    const category = allCategories.find(c => c.id === product.category_id);
    const categoryName = category ? category.name : '-';
    
    const price = product.discounted_price || product.unit_price;
    const priceHtml = product.discounted_price 
        ? `<span class="text-decoration-line-through text-muted">$${product.unit_price}</span> <span class="text-danger">$${product.discounted_price}</span>`
        : `$${product.unit_price}`;
    
    const stockBadge = product.stock > 0 
        ? `<span class="badge bg-success">${product.stock}</span>` 
        : '<span class="badge bg-danger">缺貨</span>';
    
    // 飲品圖標
    let drinkBadges = '';
    if (product.has_cold_drink) drinkBadges += '<span class="badge bg-info"><i class="fa-solid fa-snowflake"></i></span> ';
    if (product.has_hot_drink) drinkBadges += '<span class="badge bg-warning"><i class="fa-solid fa-mug-hot"></i></span>';
    if (!drinkBadges) drinkBadges = '<span class="text-muted">-</span>';
    
    const statusBadge = product.is_active 
        ? '<span class="badge bg-success">上架</span>' 
        : '<span class="badge bg-secondary">下架</span>';
    
    return `
        <tr>
            <td>${product.id}</td>
            <td>
                <strong>${product.name}</strong>
            </td>
            <td>${shopName}</td>
            <td>${categoryName}</td>
            <td>${priceHtml}</td>
            <td>${stockBadge}</td>
            <td>${drinkBadges}</td>
            <td>${statusBadge}</td>
            <td class="text-end">
                <a href="/shop/products/${product.id}/edit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> 編輯
                </a>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                    <i class="bi bi-trash"></i> 刪除
                </button>
            </td>
        </tr>
    `;
}

// 渲染表格
function renderProductsTable() {
    renderTable('productsTableBody', renderProductRow);
}

// 搜索
function performSearch() {
    const searchValue = document.getElementById('searchInput').value;
    const shopFilter = document.getElementById('shopFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const stockFilter = document.getElementById('stockFilter').value;
    
    filteredItems = allProducts.filter(product => {
        const matchSearch = !searchValue || 
            product.name.toLowerCase().includes(searchValue.toLowerCase());
        
        const matchShop = !shopFilter || product.shop_id == shopFilter;
        const matchCategory = !categoryFilter || product.category_id == categoryFilter;
        const matchStatus = !statusFilter || 
            (statusFilter === 'active' && product.is_active) ||
            (statusFilter === 'inactive' && !product.is_active);
        const matchStock = !stockFilter ||
            (stockFilter === 'in' && product.stock > 0) ||
            (stockFilter === 'out' && product.stock === 0);
        
        return matchSearch && matchShop && matchCategory && matchStatus && matchStock;
    });
    
    currentPage = 1;
    renderProductsTable();
    updatePagination();
}

// 删除产品
function deleteProduct(productId) {
    confirmDelete('確定要刪除此產品嗎？', function() {
        $.ajax({
            url: '/api/products/' + productId,
            method: 'DELETE',
            success: function() {
                showSuccess('刪除成功');
            },
            error: function() {
                showError('刪除失敗');
            }
        });
    });
}

// 初始化
$(document).ready(function() {
    window.currentRenderFunction = renderProductsTable;
    initializeDataTable('productsTableBody', allProducts, renderProductRow);
});
</script>
{% endblock %}
