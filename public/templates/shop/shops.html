{% extends "base/shop_base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">我的店鋪</h1>
        <button class="btn btn-primary" onclick="showAddShopModal()">
            <i class="bi bi-plus-lg me-2"></i>新增店鋪
        </button>
    </div>
    
    <!-- 搜索和筛选 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchInput" placeholder="搜尋店鋪名稱、描述...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">所有狀態</option>
                        <option value="active">營業中</option>
                        <option value="inactive">已關閉</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 数据表格 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>店鋪名稱</th>
                            <th>訂單ID</th>
                            <th>最大配料</th>
                            <th>狀態</th>
                            <th>建立時間</th>
                            <th class="text-end">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for shop in shops %}
                        <tr>
                            <td>{{ shop.id }}</td>
                            <td>
                                <strong>{{ shop.name }}</strong>
                                {% if shop.description %}
                                <br><small class="text-muted">{{ shop.description[:50] }}...</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ shop.shop_order_id }}</span>
                            </td>
                            <td>{{ shop.max_toppings_per_order }}</td>
                            <td>
                                {% if shop.status == 'active' %}
                                <span class="badge bg-success">營業中</span>
                                {% else %}
                                <span class="badge bg-secondary">已關閉</span>
                                {% endif %}
                            </td>
                            <td>{{ shop.created_at.strftime('%Y-%m-%d') if shop.created_at else '-' }}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-info" onclick="viewShop({{ shop.id }})">
                                    <i class="bi bi-eye"></i> 詳情
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="editShop({{ shop.id }})">
                                    <i class="bi bi-pencil"></i> 編輯
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteShop({{ shop.id }}, '{{ shop.name }}')">
                                    <i class="bi bi-trash"></i> 刪除
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-shop display-4 d-block mb-3"></i>
                                您還沒有店鋪，點擊「新增店鋪」開始建立！
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 新增/編輯店鋪模態框 -->
<div class="modal fade" id="shopModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shopModalTitle">新增店鋪</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shopForm">
                    <input type="hidden" id="shopId">
                    
                    <div class="mb-3">
                        <label for="shopName" class="form-label">店鋪名稱 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="shopName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shopOrderId" class="form-label">訂單ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="shopOrderId" required maxlength="20" pattern="[A-Z0-9]+">
                        <div class="form-text">只能使用大寫字母和數字，2-20 個字符（如：SHOP01, A001）</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shopDescription" class="form-label">店鋪描述</label>
                        <textarea class="form-control" id="shopDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="maxToppings" class="form-label">最大配料數量</label>
                        <input type="number" class="form-control" id="maxToppings" value="5" min="0" max="20">
                        <div class="form-text">顧客每筆訂單可選擇的最大配料數量</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="shopStatus" class="form-label">狀態</label>
                        <select class="form-select" id="shopStatus">
                            <option value="active">營業中</option>
                            <option value="inactive">已關閉</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveShop()">儲存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
let shopModal;

$(document).ready(function() {
    shopModal = new bootstrap.Modal(document.getElementById('shopModal'));
    
    // 搜尋過濾
    $('#searchInput, #statusFilter').on('input change', filterShops);
});

// 過濾店鋪
function filterShops() {
    const searchValue = $('#searchInput').val().toLowerCase();
    const statusFilter = $('#statusFilter').val();
    
    $('tbody tr').each(function() {
        const $row = $(this);
        const text = $row.text().toLowerCase();
        const status = $row.find('.badge').hasClass('bg-success') ? 'active' : 'inactive';
        
        const matchSearch = !searchValue || text.includes(searchValue);
        const matchStatus = !statusFilter || status === statusFilter;
        
        $row.toggle(matchSearch && matchStatus);
    });
}

// 顯示新增店鋪模態框
function showAddShopModal() {
    $('#shopModalTitle').text('新增店鋪');
    $('#shopForm')[0].reset();
    $('#shopId').val('');
    shopModal.show();
}

// 查看店鋪詳情
function viewShop(shopId) {
    window.location.href = `/shop/profile?shop_id=${shopId}`;
}

// 編輯店鋪
async function editShop(shopId) {
    try {
        const response = await fetch(`/api/shops/${shopId}`);
        const shop = await response.json();
        
        $('#shopModalTitle').text('編輯店鋪');
        $('#shopId').val(shop.id);
        $('#shopName').val(shop.name);
        $('#shopOrderId').val(shop.shop_order_id);
        $('#shopDescription').val(shop.description || '');
        $('#maxToppings').val(shop.max_toppings_per_order);
        $('#shopStatus').val(shop.status);
        
        shopModal.show();
    } catch (error) {
        alert('載入店鋪資訊失敗');
    }
}

// 儲存店鋪
async function saveShop() {
    const shopId = $('#shopId').val();
    const data = {
        name: $('#shopName').val().trim(),
        shop_order_id: $('#shopOrderId').val().trim().toUpperCase(),
        description: $('#shopDescription').val().trim(),
        max_toppings_per_order: parseInt($('#maxToppings').val()),
        status: $('#shopStatus').val()
    };
    
    // 驗證
    if (!data.name) {
        alert('請輸入店鋪名稱');
        return;
    }
    if (!data.shop_order_id) {
        alert('請輸入訂單ID');
        return;
    }
    if (!/^[A-Z0-9]+$/.test(data.shop_order_id)) {
        alert('訂單ID只能包含大寫字母和數字');
        return;
    }
    
    try {
        let response;
        if (shopId) {
            // 更新
            response = await fetch(`/api/shops/${shopId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            // 新增
            response = await fetch('/api/shops', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }
        
        if (response.ok) {
            shopModal.hide();
            location.reload();
        } else {
            const error = await response.json();
            alert(error.message || '操作失敗');
        }
    } catch (error) {
        alert('操作失敗：' + error.message);
    }
}

// 刪除店鋪（軟刪除）
async function deleteShop(shopId, shopName) {
    if (!confirm(`確定要刪除店鋪「${shopName}」嗎？\n\n此操作可以在後台恢復。`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/shops/${shopId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const error = await response.json();
            alert(error.message || '刪除失敗');
        }
    } catch (error) {
        alert('刪除失敗：' + error.message);
    }
}
</script>
{% endblock %}

