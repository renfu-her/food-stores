{% extends "base/store_base.html" %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-cart3 me-2"></i>購物車
            </h2>
        </div>
    </div>
    
    <div class="row">
        <!-- 購物車項目列表 -->
        <div class="col-lg-8">
            <div id="cartItems">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">載入中...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 結帳摘要 -->
        <div class="col-lg-4">
            <div class="card shadow-sm" id="cartSummary" style="display: none; position: sticky; top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>訂單摘要</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>商品總計</span>
                        <span id="itemsCount" class="fw-bold">0 件</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>小計</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <h5 class="mb-0">總計</h5>
                        <h5 class="mb-0 text-primary" id="cartTotal">$0</h5>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" onclick="checkout()">
                        <i class="bi bi-credit-card me-2"></i>前往結帳
                    </button>
                    <a href="{{ url_for('customer.index') }}" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="bi bi-arrow-left me-2"></i>繼續購物
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
async function loadCart() {
    try {
        // 從 API 獲取購物車
        const response = await fetch('/api/cart');
        const data = await response.json();
        const cart = data.cart || [];
        
        const cartItemsDiv = document.getElementById('cartItems');
        
        if (cart.length === 0) {
            cartItemsDiv.innerHTML = `
                <div class="card shadow-sm text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                        <h4 class="mb-3">購物車是空的</h4>
                        <p class="text-muted mb-4">還沒有添加任何商品，快去選購吧！</p>
                        <a href="{{ url_for('customer.index') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-shop me-2"></i>開始購物
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('cartSummary').style.display = 'none';
            return;
        }
        
        // 顯示購物車項目
        let html = '';
        let total = 0;
        
        for (const item of cart) {
            // 計算小計（已包含配料價格）
            const itemTotal = item.unit_price * item.quantity;
            total += itemTotal;
            
            // 顯示配料
            let toppingsHtml = '';
            if (item.toppings && item.toppings.length > 0) {
                const toppingNames = item.toppings.map(t => {
                    return t.price > 0 ? `${t.name} (+$${t.price})` : `${t.name} (FREE)`;
                }).join('、');
                toppingsHtml = `<p class="text-muted small mb-1">配料：${toppingNames}</p>`;
            }
            
            html += `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-2">${item.product_name}</h5>
                                ${toppingsHtml}
                                <p class="text-muted mb-0 small">單價：$${item.unit_price}</p>
                            </div>
                            <div class="col-md-2">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" value="${item.quantity}" min="1" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <h5 class="mb-0 text-primary">$${itemTotal}</h5>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.product_id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        cartItemsDiv.innerHTML = html;
        document.getElementById('itemsCount').textContent = cart.length + ' 件';
        document.getElementById('cartTotal').textContent = '$' + total;
        document.getElementById('subtotal').textContent = '$' + total;
        document.getElementById('cartSummary').style.display = 'block';
        
    } catch (error) {
        console.error('載入購物車失敗:', error);
        document.getElementById('cartItems').innerHTML = '<div class="alert alert-danger">載入購物車失敗</div>';
    }
}

function removeFromCart(productId) {
    if (confirm('確定要從購物車中移除這個商品嗎？')) {
        $.ajax({
            url: '/api/cart/remove',
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ product_id: productId }),
            success: function() {
                loadCart();
                updateCartCount();
            },
            error: function() {
                alert('移除失敗');
            }
        });
    }
}

function updateQuantity(productId, quantity) {
    if (quantity < 1) {
        removeFromCart(productId);
        return;
    }
    
    $.ajax({
        url: '/api/cart/update',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ 
            product_id: productId, 
            quantity: parseInt(quantity) 
        }),
        success: function() {
            loadCart();
            updateCartCount();
        },
        error: function() {
            alert('更新失敗');
            loadCart();
        }
    });
}

async function checkout() {
    try {
        // 從 API 獲取購物車
        const response = await fetch('/api/cart');
        const data = await response.json();
        const cart = data.cart || [];
        
        if (cart.length === 0) {
            alert('購物車是空的');
            return;
        }
        
        // 跳轉到結帳頁面
        window.location.href = '/store/checkout';
        
    } catch (error) {
        alert('結帳失敗，請重試');
    }
}

// 頁面載入時載入購物車
loadCart();
</script>
{% endblock %}
