{% extends "base/store_base.html" %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-cart3 me-2"></i>è³¼ç‰©è»Š
            </h2>
        </div>
    </div>
    
    <div class="row" id="cartContainer">
        <!-- è³¼ç‰©è»Šé …ç›®åˆ—è¡¨ -->
        <div class="col-lg-8" id="cartItemsColumn">
            <div id="cartItems">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çµå¸³æ‘˜è¦ -->
        <div class="col-lg-4" id="cartSummaryColumn">
            <div class="card shadow-sm" id="cartSummary" style="display: none; position: sticky; top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>è¨‚å–®æ‘˜è¦</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>å•†å“ç¸½è¨ˆ</span>
                        <span id="itemsCount" class="fw-bold">0 ä»¶</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>å°è¨ˆ</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-4">
                        <h5 class="mb-0">ç¸½è¨ˆ</h5>
                        <h5 class="mb-0 text-primary" id="cartTotal">$0</h5>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" onclick="checkout()">
                        <i class="bi bi-credit-card me-2"></i>å‰å¾€çµå¸³
                    </button>
                    <a href="{{ url_for('customer.index') }}" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="bi bi-arrow-left me-2"></i>ç¹¼çºŒè³¼ç‰©
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
async function loadCart() {
    try {
        // å¾ API ç²å–è³¼ç‰©è»Š
        const response = await fetch('/api/cart');
        const data = await response.json();
        const cart = data.cart || [];
        
        const cartItemsDiv = document.getElementById('cartItems');
        
        if (cart.length === 0) {
            // ç©ºè³¼ç‰©è»Šï¼šæ”¹ç‚ºå…¨å¯¬é¡¯ç¤º
            document.getElementById('cartItemsColumn').className = 'col-12';
            document.getElementById('cartSummaryColumn').style.display = 'none';
            
            cartItemsDiv.innerHTML = `
                <div class="card shadow-sm text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                        <h4 class="mb-3">è³¼ç‰©è»Šæ˜¯ç©ºçš„</h4>
                        <p class="text-muted mb-4">é‚„æ²’æœ‰æ·»åŠ ä»»ä½•å•†å“ï¼Œå¿«å»é¸è³¼å§ï¼</p>
                        <a href="{{ url_for('customer.index') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-shop me-2"></i>é–‹å§‹è³¼ç‰©
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('cartSummary').style.display = 'none';
            return;
        }
        
        // æœ‰å•†å“æ™‚ï¼šæ¢å¾©å·¦å³åˆ†æ¬„
        document.getElementById('cartItemsColumn').className = 'col-lg-8';
        document.getElementById('cartSummaryColumn').style.display = 'block';
        
        // é¡¯ç¤ºè³¼ç‰©è»Šé …ç›®
        let html = '';
        let total = 0;
        
        for (const item of cart) {
            // è¨ˆç®—å°è¨ˆï¼ˆå·²åŒ…å«é…æ–™åƒ¹æ ¼ï¼‰
            const itemTotal = item.unit_price * item.quantity;
            total += itemTotal;
            
            // é¡¯ç¤ºé…æ–™
            let toppingsHtml = '';
            if (item.toppings && item.toppings.length > 0) {
                const toppingNames = item.toppings.map(t => {
                    return t.price > 0 ? `${t.name} (+$${t.price})` : `${t.name} (FREE)`;
                }).join('ã€');
                toppingsHtml = `<p class="text-muted small mb-1">é…æ–™ï¼š${toppingNames}</p>`;
            }
            
            // é¡¯ç¤ºé£²å“é¸é …
            let drinkHtml = '';
            if (item.drink_type) {
                const drinkName = item.drink_type === 'cold' ? 'ğŸ§Š å†·é£²' : 'â˜• ç†±é£²';
                const drinkPriceDisplay = item.drink_price > 0 ? ` (+$${item.drink_price})` : '';
                drinkHtml = `<p class="text-muted small mb-1">é£²å“ï¼š${drinkName}${drinkPriceDisplay}</p>`;
            }
            
            html += `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-2">${item.product_name}</h5>
                                ${toppingsHtml}
                                ${drinkHtml}
                                <p class="text-muted mb-0 small">å–®åƒ¹ï¼š$${item.unit_price}</p>
                            </div>
                            <div class="col-md-2">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.product_id}, ${item.quantity - 1})">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" value="${item.quantity}" min="1" readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.product_id}, ${item.quantity + 1})">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <h5 class="mb-0 text-primary">$${itemTotal}</h5>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.product_id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        cartItemsDiv.innerHTML = html;
        document.getElementById('itemsCount').textContent = cart.length + ' ä»¶';
        document.getElementById('cartTotal').textContent = '$' + total;
        document.getElementById('subtotal').textContent = '$' + total;
        document.getElementById('cartSummary').style.display = 'block';
        
    } catch (error) {
        console.error('è¼‰å…¥è³¼ç‰©è»Šå¤±æ•—:', error);
        document.getElementById('cartItems').innerHTML = '<div class="alert alert-danger">è¼‰å…¥è³¼ç‰©è»Šå¤±æ•—</div>';
    }
}

function removeFromCart(productId) {
    if (confirm('ç¢ºå®šè¦å¾è³¼ç‰©è»Šä¸­ç§»é™¤é€™å€‹å•†å“å—ï¼Ÿ')) {
        $.ajax({
            url: '/api/cart/remove',
            method: 'DELETE',
            contentType: 'application/json',
            data: JSON.stringify({ product_id: productId }),
            success: function() {
                loadCart();
                updateCartCount();
            },
            error: function() {
                alert('ç§»é™¤å¤±æ•—');
            }
        });
    }
}

function updateQuantity(productId, quantity) {
    if (quantity < 1) {
        removeFromCart(productId);
        return;
    }
    
    $.ajax({
        url: '/api/cart/update',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ 
            product_id: productId, 
            quantity: parseInt(quantity) 
        }),
        success: function() {
            loadCart();
            updateCartCount();
        },
        error: function() {
            alert('æ›´æ–°å¤±æ•—');
            loadCart();
        }
    });
}

async function checkout() {
    try {
        // å¾ API ç²å–è³¼ç‰©è»Š
        const response = await fetch('/api/cart');
        const data = await response.json();
        const cart = data.cart || [];
        
        if (cart.length === 0) {
            alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„');
            return;
        }
        
        // è·³è½‰åˆ°çµå¸³é é¢
        window.location.href = "{{ url_for('customer.checkout') }}";
        
    } catch (error) {
        alert('çµå¸³å¤±æ•—ï¼Œè«‹é‡è©¦');
    }
}

// é é¢è¼‰å…¥æ™‚è¼‰å…¥è³¼ç‰©è»Š
loadCart();
</script>
{% endblock %}
