{% extends "base/app.html" %}

{% block content %}
<div class="container py-5">
    <div class="mb-4">
        <a href="{{ url_for('customer.profile') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>返回个人中心
        </a>
    </div>
    
    <h1 class="mb-4"><i class="bi bi-gift me-2"></i>我的回馈金</h1>
    
    <!-- 余额卡片 -->
    <div class="card mb-4 shadow">
        <div class="card-body text-center py-5">
            <h6 class="text-muted mb-3">当前余额</h6>
            <h1 class="display-1 text-primary mb-3 fw-bold">{{ user.points }}</h1>
            <p class="text-muted mb-4">点（1点 = $1）</p>
            
            <div class="mt-4">
                <a href="{{ url_for('customer.index') }}" class="btn btn-primary btn-lg me-2">
                    <i class="bi bi-cart me-2"></i>去购物
                </a>
                <button class="btn btn-outline-primary btn-lg" onclick="refreshTransactions()">
                    <i class="bi bi-arrow-clockwise me-2"></i>刷新
                </button>
            </div>
        </div>
    </div>
    
    <!-- 使用说明 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fa-solid fa-coins text-warning mb-3" style="font-size: 3rem;"></i>
                    <h5>如何赚取？</h5>
                    <p class="small text-muted">每次消费都会根据店铺设置自动累积回馈金</p>
                    <p class="small text-info">例如：消费$150，店铺设置30元=1点，可获得5点</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fa-solid fa-wallet text-success mb-3" style="font-size: 3rem;"></i>
                    <h5>如何使用？</h5>
                    <p class="small text-muted">结账时可以使用回馈金抵扣订单金额</p>
                    <p class="small text-info">1点回馈金 = $1，可自由选择使用多少</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fa-solid fa-shop text-info mb-3" style="font-size: 3rem;"></i>
                    <h5>跨店使用</h5>
                    <p class="small text-muted">回馈金可以在任意店铺使用</p>
                    <p class="small text-info">在A店赚取，在B店使用，自由灵活</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 交易明细 -->
    <div class="card shadow">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>交易明细</h5>
        </div>
        <div class="card-body">
            {% if transactions %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>类型</th>
                            <th>点数</th>
                            <th>余额</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        {% for t in transactions %}
                        <tr>
                            <td class="small">{{ t.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if t.type == 'earn' %}
                                <span class="badge bg-success">赚取</span>
                                {% elif t.type == 'use' %}
                                <span class="badge bg-warning text-dark">使用</span>
                                {% elif t.type == 'expire' %}
                                <span class="badge bg-danger">过期</span>
                                {% endif %}
                            </td>
                            <td class="fw-bold {% if t.points > 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if t.points > 0 %}+{% endif %}{{ t.points }}
                            </td>
                            <td>{{ t.balance }}</td>
                            <td class="small text-muted">{{ t.description }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="loadMore()" id="loadMoreBtn">
                    <i class="bi bi-arrow-down-circle me-2"></i>加载更多
                </button>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="fa-solid fa-inbox" style="font-size: 4rem; opacity: 0.2;"></i>
                <p class="mt-4 fs-5">暂无交易记录</p>
                <p class="small">消费后即可开始累积回馈金</p>
                <a href="{{ url_for('customer.index') }}" class="btn btn-primary mt-3">
                    <i class="bi bi-cart me-2"></i>开始购物
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
let currentPage = 1;

function loadMore() {
    currentPage++;
    
    $.get(`/api/users/points/transactions?page=${currentPage}&per_page=20`, function(data) {
        if (data.transactions.length === 0) {
            $('#loadMoreBtn').prop('disabled', true).text('没有更多记录');
            return;
        }
        
        const tbody = $('#transactionsTable');
        data.transactions.forEach(t => {
            const typeMap = {
                'earn': '<span class="badge bg-success">赚取</span>',
                'use': '<span class="badge bg-warning text-dark">使用</span>',
                'expire': '<span class="badge bg-danger">过期</span>'
            };
            
            const pointsClass = t.points > 0 ? 'text-success' : 'text-danger';
            const pointsSign = t.points > 0 ? '+' : '';
            
            const row = `
                <tr>
                    <td class="small">${new Date(t.created_at).toLocaleString('zh-TW')}</td>
                    <td>${typeMap[t.type] || t.type}</td>
                    <td class="fw-bold ${pointsClass}">${pointsSign}${t.points}</td>
                    <td>${t.balance}</td>
                    <td class="small text-muted">${t.description || '-'}</td>
                </tr>
            `;
            tbody.append(row);
        });
        
        if (currentPage >= data.pages) {
            $('#loadMoreBtn').prop('disabled', true).text('已加载全部记录');
        }
    });
}

function refreshTransactions() {
    location.reload();
}
</script>
{% endblock %}

