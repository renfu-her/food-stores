{% extends "base/store_base.html" %}

{% block content %}
<!-- åº—é‹ª Banner æ©«å¹… (4:1 æ¯”ä¾‹) -->
{% if shop.banner_image %}
<div class="position-relative mb-3" style="width: 100%; padding-top: 25%; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <img src="{{ shop.banner_image }}" class="position-absolute top-0 start-0 w-100 h-100" alt="{{ shop.name }} Banner" style="object-fit: cover;">
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.3) 100%);"></div>
    <div class="position-absolute bottom-0 start-0 w-100 p-4 text-white">
        <h1 class="display-4 mb-2">{{ shop.name }}</h1>
        <p class="lead mb-0">{{ shop.description or 'æ­¡è¿å…‰è‡¨' }}</p>
    </div>
</div>
{% else %}
<div class="container mb-3">
    <div class="page-header">
        <h1>{{ shop.name }}</h1>
        <p class="shop-description">{{ shop.description or 'æš«ç„¡æè¿°' }}</p>
    </div>
</div>
{% endif %}

<div class="container">
    
    <div class="mb-3">
        <select id="categoryFilter" onchange="filterProducts()" class="form-select" style="max-width: 300px;">
            <option value="">å…¨éƒ¨åˆ†é¡</option>
            {% for category in categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    {% if products %}
    <div class="row g-3">
        {% for product in products %}
        <div class="col-sm-6 col-md-4 col-lg-3 product-card-item" data-category="{{ product.category_id }}">
            <div class="card h-100 shadow-sm">
                <!-- ç”¢å“åœ–ç‰‡ï¼ˆå¯é»æ“Šï¼‰ -->
                <div class="position-relative" style="cursor: pointer;" onclick="showProductDetail({{ product.id }})">
                    {% if product.images and product.images|length > 0 %}
                        <img class="card-img-top" src="{{ product.images[0].image_path }}" alt="{{ product.name }}" style="width:100%">
                    {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="min-height: 200px;">
                            <i class="bi bi-box-seam display-4 text-muted"></i>
                        </div>
                    {% endif %}
                    <!-- æ‡¸åœæç¤º -->
                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
                         style="background: rgba(0,0,0,0); transition: all 0.3s ease;"
                         onmouseenter="this.style.background='rgba(0,0,0,0.5)'; this.querySelector('.hover-icon').style.opacity='1';"
                         onmouseleave="this.style.background='rgba(0,0,0,0)'; this.querySelector('.hover-icon').style.opacity='0';">
                        <i class="bi bi-eye-fill text-white hover-icon" style="font-size: 3rem; opacity: 0; transition: opacity 0.3s ease;"></i>
                    </div>
                </div>
                
                <div class="card-body p-2">
                    <h4 class="card-title mb-1" style="cursor: pointer;" onclick="showProductDetail({{ product.id }})">
                        <span class="text-primary text-decoration-none">{{ product.name }}</span>
                    </h4>
                    <p class="card-text text-muted small mb-1" style="min-height: 40px;">{{ product.description or 'æš«ç„¡æè¿°' }}</p>
                    <div class="mb-1">
                        {% if product.discounted_price %}
                            <span class="text-decoration-line-through text-muted me-2">${{ product.unit_price|int }}</span>
                            <span class="text-danger fw-bold fs-5">${{ product.discounted_price|int }}</span>
                        {% else %}
                            <span class="fw-bold fs-5">${{ product.unit_price|int }}</span>
                        {% endif %}
                    </div>
                    <div class="mb-1">
                        {% if product.stock_quantity > 0 %}
                            <span class="badge bg-success">âœ“ æœ‰åº«å­˜ ({{ product.stock_quantity }})</span>
                        {% else %}
                            <span class="badge bg-danger">âœ— ç¼ºè²¨</span>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="showProductDetail({{ product.id }})">æŸ¥çœ‹è©³æƒ…</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>æ­¤åº—é‹ªæš«ç„¡ç”¢å“</p>
    </div>
    {% endif %}
</div>

<!-- ç”¢å“è©³æƒ…æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">ç”¢å“è©³æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <!-- ç”¢å“åœ–ç‰‡è¼ªæ’­ -->
                        <div id="productImageCarousel" class="carousel slide" data-bs-ride="false">
                            <div class="carousel-inner" id="productCarouselInner">
                                <!-- åœ–ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#productImageCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productImageCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h3 id="productModalName" class="mb-3"></h3>
                        <p id="productModalDescription" class="text-muted mb-3"></p>
                        
                        <div class="mb-3">
                            <div id="productModalPrice"></div>
                        </div>
                        
                        <div class="mb-3">
                            <span id="productModalStock"></span>
                        </div>
                        
                        <!-- é…æ–™é¸æ“‡ -->
                        <div id="toppingsSection" class="mb-3" style="display: none;">
                            <label class="form-label mb-2">
                                é…æ–™é¸æ“‡ 
                                <small class="text-muted" id="toppingLimit"></small>
                            </label>
                            <div id="toppingsList" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                                <!-- é…æ–™å°‡å‹•æ…‹è¼‰å…¥ -->
                            </div>
                            <small class="text-muted d-block mt-2">
                                å·²é¸ <span id="selectedToppingCount">0</span> å€‹é…æ–™
                            </small>
                        </div>
                        
                        <!-- é£²å“é¸æ“‡ -->
                        <div id="drinksSection" class="mb-3" style="display: none;">
                            <label class="form-label mb-2">é£²å“é¸æ“‡</label>
                            <div class="border rounded p-2">
                                <div id="drinksList">
                                    <!-- é£²å“é¸é …å°‡å‹•æ…‹è¼‰å…¥ -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="productQuantity" class="form-label mb-2">æ•¸é‡</label>
                            <input type="number" class="form-control" id="productQuantity" value="1" min="1" onchange="updateTotalPrice()">
                        </div>
                        
                        <!-- ç¸½åƒ¹é¡¯ç¤º -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                <span class="fw-bold">ç¸½åƒ¹ï¼š</span>
                                <span id="totalPrice" class="fs-4 fw-bold text-primary">$0</span>
                            </div>
                        </div>
                        
                        <div id="productModalError" class="alert alert-danger mt-3" style="display: none;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="addToCart()">
                    <i class="bi bi-cart-plus me-2"></i>åŠ å…¥è³¼ç‰©è»Š
                </button>
                <button type="button" class="btn btn-primary" onclick="buyNow()">
                    <i class="bi bi-credit-card me-2"></i>ç›´æ¥çµå¸³
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
let currentProduct = null;
let productModal;

$(document).ready(function() {
    productModal = new bootstrap.Modal(document.getElementById('productModal'));
});

// è¼‰å…¥ç”¢å“åœ–ç‰‡è¼ªæ’­
function loadProductImages(product) {
    const carouselInner = $('#productCarouselInner');
    carouselInner.empty();
    
    if (product.images && product.images.length > 0) {
        // æœ‰åœ–ç‰‡ï¼šå»ºç«‹è¼ªæ’­
        product.images.forEach((image, index) => {
            const activeClass = index === 0 ? 'active' : '';
            const carouselItem = `
                <div class="carousel-item ${activeClass}">
                    <img src="${image.image_path}" class="d-block w-100 rounded" alt="${product.name}" style="max-height: 400px; object-fit: contain;">
                </div>
            `;
            carouselInner.append(carouselItem);
        });
        
        // åªæœ‰ä¸€å¼µåœ–ç‰‡æ™‚éš±è—å·¦å³åˆ‡æ›æŒ‰éˆ•
        if (product.images.length <= 1) {
            $('.carousel-control-prev, .carousel-control-next').hide();
        } else {
            $('.carousel-control-prev, .carousel-control-next').show();
        }
    } else {
        // ç„¡åœ–ç‰‡ï¼šé¡¯ç¤ºé è¨­åœ–æ¨™
        const noImageHtml = `
            <div class="carousel-item active">
                <div class="d-flex align-items-center justify-content-center bg-light rounded" style="min-height: 300px;">
                    <i class="bi bi-box-seam display-1 text-muted"></i>
                </div>
            </div>
        `;
        carouselInner.html(noImageHtml);
        $('.carousel-control-prev, .carousel-control-next').hide();
    }
}

function filterProducts() {
    const categoryId = document.getElementById('categoryFilter').value;
    const cards = document.querySelectorAll('.product-card-item');
    cards.forEach(card => {
        if (!categoryId || card.dataset.category == categoryId) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// é¡¯ç¤ºç”¢å“è©³æƒ…æ¨¡æ…‹æ¡†
function showProductDetail(productId) {
    $.ajax({
        url: `/api/products/${productId}`,
        method: 'GET',
        success: function(product) {
            currentProduct = product;
            
            // è¼‰å…¥ç”¢å“åœ–ç‰‡ï¼ˆæ”¯æŒå¤šå¼µåœ–ç‰‡è¼ªæ’­ï¼‰
            loadProductImages(product);
            
            // è¨­ç½®æ¨™é¡Œå’Œæè¿°
            $('#productModalTitle').text(product.name);
            $('#productModalName').text(product.name);
            $('#productModalDescription').text(product.description || 'æš«ç„¡æè¿°');
            
            // è¨­ç½®åƒ¹æ ¼
            let priceHtml = '';
            if (product.discounted_price) {
                priceHtml = `
                    <span class="text-decoration-line-through text-muted me-2 fs-5">$${product.unit_price}</span>
                    <span class="text-danger fw-bold fs-3">$${product.discounted_price}</span>
                `;
            } else {
                priceHtml = `<span class="fw-bold fs-3">$${product.unit_price}</span>`;
            }
            $('#productModalPrice').html(priceHtml);
            
            // è¨­ç½®åº«å­˜
            let stockHtml = '';
            if (product.stock_quantity > 0) {
                stockHtml = `<span class="badge bg-success fs-6">âœ“ æœ‰åº«å­˜ (${product.stock_quantity})</span>`;
                $('#productQuantity').attr('max', product.stock_quantity).attr('disabled', false);
            } else {
                stockHtml = `<span class="badge bg-danger fs-6">âœ— ç¼ºè²¨</span>`;
                $('#productQuantity').attr('disabled', true);
            }
            $('#productModalStock').html(stockHtml);
            
            // è¼‰å…¥é…æ–™é¸é …
            loadToppings(product);
            
            // è¼‰å…¥é£²å“é¸é …
            loadDrinks(product);
            
            // é‡ç½®æ•¸é‡
            $('#productQuantity').val(1);
            $('#productModalError').hide();
            
            // æ›´æ–°ç¸½åƒ¹
            updateTotalPrice();
            
            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            productModal.show();
        },
        error: function() {
            alert('ç„¡æ³•è¼‰å…¥ç”¢å“è©³æƒ…');
        }
    });
}

// è¼‰å…¥é…æ–™é¸é …ï¼ˆå¾åº—é‹ªç²å–ï¼‰
function loadToppings(product) {
    const toppingsList = $('#toppingsList');
    toppingsList.empty();
    
    // ç²å–åº—é‹ªçš„é…æ–™å’Œä¸Šé™
    $.ajax({
        url: `/api/shops/${product.shop_id}`,
        method: 'GET',
        success: function(shop) {
            const maxToppings = shop.max_toppings_per_order || 5;
            
            // ç²å–åº—é‹ªçš„é…æ–™åˆ—è¡¨
            $.ajax({
                url: `/api/toppings?shop_id=${product.shop_id}&is_active=true`,
                method: 'GET',
                success: function(response) {
                    const toppings = response.toppings || response;
                    
                    if (toppings && toppings.length > 0) {
                        // é¡¯ç¤ºé…æ–™å€åŸŸ
                        $('#toppingsSection').show();
                        $('#toppingLimit').text(`(æœ€å¤š ${maxToppings} å€‹)`);
                        
                        // å»ºç«‹é…æ–™é¸é …
                        toppings.forEach(topping => {
                            const priceDisplay = topping.price == 0 ? 'FREE' : `+$${topping.price}`;
                            const toppingHtml = `
                                <div class="form-check mb-2">
                                    <input class="form-check-input topping-checkbox" 
                                           type="checkbox" 
                                           id="topping_${topping.id}" 
                                           value="${topping.id}"
                                           data-price="${topping.price}"
                                           data-name="${topping.name}"
                                           onchange="handleToppingChange(${maxToppings})">
                                    <label class="form-check-label d-flex justify-content-between w-100" for="topping_${topping.id}">
                                        <span>${topping.name}</span>
                                        <span class="text-muted">${priceDisplay}</span>
                                    </label>
                                </div>
                            `;
                            toppingsList.append(toppingHtml);
                        });
                    } else {
                        // ç„¡é…æ–™
                        $('#toppingsSection').hide();
                    }
                },
                error: function() {
                    $('#toppingsSection').hide();
                }
            });
        },
        error: function() {
            $('#toppingsSection').hide();
        }
    });
}

// è™•ç†é…æ–™å‹¾é¸è®ŠåŒ–
function handleToppingChange(maxToppings) {
    const selectedCount = $('.topping-checkbox:checked').length;
    $('#selectedToppingCount').text(selectedCount);
    
    // æª¢æŸ¥æ˜¯å¦è¶…éä¸Šé™
    if (selectedCount >= maxToppings) {
        // ç¦ç”¨æœªé¸ä¸­çš„é…æ–™
        $('.topping-checkbox:not(:checked)').attr('disabled', true);
    } else {
        // å•Ÿç”¨æ‰€æœ‰é…æ–™
        $('.topping-checkbox').attr('disabled', false);
    }
    
    // æ›´æ–°ç¸½åƒ¹
    updateTotalPrice();
}

// è¼‰å…¥é£²å“é¸é …
function loadDrinks(product) {
    const drinksList = $('#drinksList');
    const drinksSection = $('#drinksSection');
    drinksList.empty();
    
    // æª¢æŸ¥ç”¢å“æ˜¯å¦æœ‰é£²å“é¸é …
    const hasDrinks = product.has_cold_drink || product.has_hot_drink;
    
    if (hasDrinks) {
        drinksSection.show();
        
        let drinksHtml = '';
        
        // æ·»åŠ å†·é£²é¸é …
        if (product.has_cold_drink) {
            const coldPrice = product.cold_drink_price || 0;
            const priceDisplay = coldPrice === 0 ? '' : ` (+$${coldPrice})`;
            drinksHtml += `
                <div class="form-check mb-2">
                    <input class="form-check-input drink-radio" 
                           type="radio" 
                           name="drinkType" 
                           id="drink_cold" 
                           value="cold"
                           data-price="${coldPrice}"
                           onchange="updateTotalPrice()">
                    <label class="form-check-label d-flex justify-content-between w-100" for="drink_cold">
                        <span>ğŸ§Š å†·é£²</span>
                        <span class="text-muted">${priceDisplay}</span>
                    </label>
                </div>
            `;
        }
        
        // æ·»åŠ ç†±é£²é¸é …
        if (product.has_hot_drink) {
            const hotPrice = product.hot_drink_price || 0;
            const priceDisplay = hotPrice === 0 ? '' : ` (+$${hotPrice})`;
            drinksHtml += `
                <div class="form-check mb-2">
                    <input class="form-check-input drink-radio" 
                           type="radio" 
                           name="drinkType" 
                           id="drink_hot" 
                           value="hot"
                           data-price="${hotPrice}"
                           onchange="updateTotalPrice()">
                    <label class="form-check-label d-flex justify-content-between w-100" for="drink_hot">
                        <span>â˜• ç†±é£²</span>
                        <span class="text-muted">${priceDisplay}</span>
                    </label>
                </div>
            `;
        }
        
        // æ·»åŠ ã€Œä¸éœ€è¦ã€é¸é …ï¼ˆé è¨­é¸ä¸­ï¼‰
        drinksHtml += `
            <div class="form-check mb-2">
                <input class="form-check-input drink-radio" 
                       type="radio" 
                       name="drinkType" 
                       id="drink_none" 
                       value="none"
                       data-price="0"
                       checked
                       onchange="updateTotalPrice()">
                <label class="form-check-label" for="drink_none">
                    <span>ä¸éœ€è¦</span>
                </label>
            </div>
        `;
        
        drinksList.html(drinksHtml);
    } else {
        drinksSection.hide();
    }
}

// æ›´æ–°ç¸½åƒ¹
function updateTotalPrice() {
    if (!currentProduct) return;
    
    const quantity = parseInt($('#productQuantity').val()) || 1;
    const basePrice = currentProduct.discounted_price || currentProduct.unit_price;
    
    // è¨ˆç®—é…æ–™ç¸½åƒ¹
    let toppingsPrice = 0;
    $('.topping-checkbox:checked').each(function() {
        toppingsPrice += parseFloat($(this).data('price')) || 0;
    });
    
    // è¨ˆç®—é£²å“åƒ¹æ ¼
    let drinkPrice = 0;
    const selectedDrink = $('input[name="drinkType"]:checked');
    if (selectedDrink.length > 0 && selectedDrink.val() !== 'none') {
        drinkPrice = parseFloat(selectedDrink.data('price')) || 0;
    }
    
    // ç¸½åƒ¹ = (ç”¢å“åƒ¹æ ¼ + é…æ–™ç¸½åƒ¹ + é£²å“åƒ¹æ ¼) Ã— æ•¸é‡
    const totalPrice = (basePrice + toppingsPrice + drinkPrice) * quantity;
    $('#totalPrice').text(`$${totalPrice}`);
}

// åŠ å…¥è³¼ç‰©è»Š
function addToCart() {
    if (!currentProduct) return;
    
    const quantity = parseInt($('#productQuantity').val());
    
    if (quantity < 1) {
        $('#productModalError').text('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡').show();
        return;
    }
    
    if (currentProduct.stock_quantity < quantity) {
        $('#productModalError').text('åº«å­˜ä¸è¶³').show();
        return;
    }
    
    // æ”¶é›†é¸ä¸­çš„é…æ–™
    const selectedToppings = [];
    $('.topping-checkbox:checked').each(function() {
        selectedToppings.push({
            id: parseInt($(this).val()),
            name: $(this).data('name'),
            price: parseFloat($(this).data('price'))
        });
    });
    
    // æ”¶é›†é£²å“é¸æ“‡
    let drinkType = null;
    let drinkPrice = null;
    const selectedDrink = $('input[name="drinkType"]:checked');
    if (selectedDrink.length > 0 && selectedDrink.val() !== 'none') {
        drinkType = selectedDrink.val();
        drinkPrice = parseFloat(selectedDrink.data('price'));
    }
    
    $.ajax({
        url: '/api/cart/add',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: currentProduct.id,
            quantity: quantity,
            toppings: selectedToppings,
            drink_type: drinkType,
            drink_price: drinkPrice
        }),
        success: function(response) {
            productModal.hide();
            alert('å·²åŠ å…¥è³¼ç‰©è»Šï¼');
            // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡é¡¯ç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
            if (typeof updateCartCount === 'function') {
                updateCartCount();
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON || {};
            $('#productModalError').text(error.error || 'åŠ å…¥è³¼ç‰©è»Šå¤±æ•—').show();
        }
    });
}

// ç›´æ¥çµå¸³
function buyNow() {
    if (!currentProduct) return;
    
    const quantity = parseInt($('#productQuantity').val());
    
    if (quantity < 1) {
        $('#productModalError').text('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡').show();
        return;
    }
    
    if (currentProduct.stock_quantity < quantity) {
        $('#productModalError').text('åº«å­˜ä¸è¶³').show();
        return;
    }
    
    // æ”¶é›†é¸ä¸­çš„é…æ–™
    const selectedToppings = [];
    $('.topping-checkbox:checked').each(function() {
        selectedToppings.push({
            id: parseInt($(this).val()),
            name: $(this).data('name'),
            price: parseFloat($(this).data('price'))
        });
    });
    
    // æ”¶é›†é£²å“é¸æ“‡
    let drinkType = null;
    let drinkPrice = null;
    const selectedDrink = $('input[name="drinkType"]:checked');
    if (selectedDrink.length > 0 && selectedDrink.val() !== 'none') {
        drinkType = selectedDrink.val();
        drinkPrice = parseFloat(selectedDrink.data('price'));
    }
    
    // åŠ å…¥è³¼ç‰©è»Šä¸¦è·³è½‰åˆ°çµå¸³é é¢
    $.ajax({
        url: '/api/cart/add',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            product_id: currentProduct.id,
            quantity: quantity,
            toppings: selectedToppings,
            drink_type: drinkType,
            drink_price: drinkPrice
        }),
        success: function(response) {
            window.location.href = "{{ url_for('customer.checkout') }}";
        },
        error: function(xhr) {
            const error = xhr.responseJSON || {};
            $('#productModalError').text(error.error || 'æ“ä½œå¤±æ•—').show();
        }
    });
}

// ç›£è½ç”¢å“æ›´æ–°äº‹ä»¶
window.addEventListener('productUpdated', function(event) {
    const data = event.detail;
    if (data.shop_id == {{ shop.id }}) {
        console.log('ç”¢å“æ›´æ–°:', data);
        location.reload();
    }
});
</script>
{% endblock %}
