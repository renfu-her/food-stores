{% extends "base/store_base.html" %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-credit-card me-2"></i>結帳
            </h2>
        </div>
    </div>
    
    <div class="row">
        <!-- 左側：收貨信息 -->
        <div class="col-lg-8">
            <!-- 收貨地址 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>收貨地址</h5>
                </div>
                <div class="card-body">
                    <form id="addressForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="recipient_name" class="form-label">收貨人姓名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="recipient_name" value="{{ user.name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="recipient_phone" class="form-label">聯絡電話 <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="recipient_phone" value="{{ user.phone or '' }}" required>
                            </div>
                            
                            <!-- TWzipcode 地址選擇器 -->
                            <div class="col-12">
                                <label class="form-label">地址 <span class="text-danger">*</span></label>
                                <div id="twzipcode">
                                    <div data-role="county" data-name="county" data-style="form-select mb-2"></div>
                                    <div data-role="district" data-name="district" data-style="form-select mb-2"></div>
                                    <div data-role="zipcode" data-name="zipcode" data-style="form-control mb-2" data-readonly="true" data-placeholder="郵遞區號"></div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label for="recipient_address" class="form-label">詳細地址 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="recipient_address" rows="2" placeholder="請輸入詳細地址（街道、巷弄、門牌號碼等）" required>{{ user.address or '' }}</textarea>
                            </div>
                            
                            <!-- 完整地址預覽 -->
                            <div class="col-12">
                                <div class="alert alert-info" role="alert">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>完整地址：</strong>
                                    <span id="fullAddress">
                                        {% if user.county and user.district and user.zipcode %}
                                            {{ user.zipcode }} {{ user.county }}{{ user.district }}{{ user.address or '' }}
                                        {% else %}
                                            請選擇地址
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <label for="delivery_note" class="form-label">備註</label>
                                <textarea class="form-control" id="delivery_note" rows="2" placeholder="如有特殊需求，請在此填寫..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 回馈金使用 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-gift me-2"></i>使用回馈金</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>可用回馈金：</span>
                        <strong class="text-primary fs-5"><span id="availablePoints">{{ user.points }}</span> 点</strong>
                    </div>
                    
                    <div class="input-group mb-2">
                        <span class="input-group-text">使用</span>
                        <input type="number" class="form-control" id="pointsToUse" min="0" max="{{ user.points }}" value="0" onchange="calculateTotal()">
                        <span class="input-group-text">点（1点=$1）</span>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="useAllPoints()">
                            <i class="bi bi-check-all me-1"></i>使用全部
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearPoints()">
                            <i class="bi bi-x me-1"></i>清除
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 購物車商品 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-bag-check me-2"></i>訂單商品</h5>
                </div>
                <div class="card-body" id="orderItems">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">載入中...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 支付方式（组合支付）-->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>支付方式（可组合）</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle me-1"></i>您可以使用多种支付方式组合支付此订单
                    </p>
                    
                    <div id="paymentMethodsList">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span class="ms-2 text-muted">载入支付方式...</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-light mt-3">
                        <table class="table table-sm mb-0">
                            <tr>
                                <td>订单总额：</td>
                                <td class="text-end fw-bold">$<span id="orderTotalCalc">0</span></td>
                            </tr>
                            <tr class="text-success">
                                <td><i class="bi bi-gift me-1"></i>使用回馈金：</td>
                                <td class="text-end">-$<span id="pointsDiscount">0</span></td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>应付金额：</strong></td>
                                <td class="text-end"><strong class="text-primary fs-5">$<span id="amountDue">0</span></strong></td>
                            </tr>
                            <tr>
                                <td>已分配支付：</td>
                                <td class="text-end">$<span id="paymentAllocated">0</span></td>
                            </tr>
                            <tr class="text-info">
                                <td><i class="bi bi-star me-1"></i>本次可获得：</td>
                                <td class="text-end fw-bold"><span id="pointsToEarn">0</span> 点回馈金</td>
                            </tr>
                        </table>
                        
                        <div id="paymentError" class="alert alert-danger mt-2" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右側：訂單摘要 -->
        <div class="col-lg-4">
            <div class="card shadow-sm" style="position: sticky; top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>訂單摘要</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>商品總計</span>
                        <span id="itemsCount">0 件</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>小計</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-success">
                        <span><i class="bi bi-gift me-1"></i>回馈金折扣</span>
                        <span id="pointsDiscountSummary">-$0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>運費</span>
                        <span id="shippingFee" class="text-success">免運費</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <h5 class="mb-0">應付金額</h5>
                        <h5 class="mb-0 text-primary" id="orderTotal">$0</h5>
                    </div>
                    <div class="d-flex justify-content-between mb-4 text-info small">
                        <span><i class="bi bi-star me-1"></i>可获回馈金</span>
                        <strong><span id="pointsToEarnSummary">0</span> 点</strong>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg mb-3" onclick="submitOrder()">
                        <i class="bi bi-check-circle me-2"></i>確認訂單
                    </button>
                    <a href="{{ url_for('customer.cart') }}" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-left me-2"></i>返回購物車
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="{{ url_for('static', filename='js/jquery.twzipcode.js') }}"></script>
<script>
let cartData = [];
let paymentMethods = [];
let currentShopId = null;

$(document).ready(function() {
    // 初始化 TWzipcode
    $('#twzipcode').twzipcode({
        'css': ['form-select mb-2', 'form-select mb-2', 'form-control mb-2']
    });
    
    {% if user.county and user.district and user.zipcode %}
    // 設置預設值
    $('#twzipcode').twzipcode('set', {
        'county': '{{ user.county }}',
        'district': '{{ user.district }}',
        'zipcode': '{{ user.zipcode }}'
    });
    {% endif %}
    
    // 監聽地址變更，更新完整地址預覽
    $('#twzipcode').on('change', 'select, input', function() {
        updateFullAddress();
    });
    
    $('#recipient_address').on('input', function() {
        updateFullAddress();
    });
    
    function updateFullAddress() {
        const county = $('select[name="county"]').val();
        const district = $('select[name="district"]').val();
        const zipcode = $('input[name="zipcode"]').val();
        const address = $('#recipient_address').val();
        
        if (county && district && zipcode) {
            const full = zipcode + ' ' + county + district + (address || '');
            $('#fullAddress').text(full);
        } else {
            $('#fullAddress').text('請選擇地址');
        }
    }
});

// 載入購物車數據
async function loadCheckoutData() {
    try {
        const response = await fetch('/api/cart');
        const data = await response.json();
        cartData = data.cart || [];
        
        if (cartData.length === 0) {
            alert('購物車是空的');
            window.location.href = '{{ url_for("customer.cart") }}';
            return;
        }
        
        // 获取店铺ID（假设购物车中所有商品来自同一店铺）
        if (cartData.length > 0) {
            currentShopId = cartData[0].shop_id;
            loadPaymentMethods();
        }
        
        displayOrderItems();
        updateOrderSummary();
        calculateTotal();
        
    } catch (error) {
        console.error('載入購物車失敗:', error);
        alert('載入失敗，請重試');
    }
}

// 加载店铺支付方式
function loadPaymentMethods() {
    $.get(`/api/shops/${currentShopId}/payment-methods/public`, function(data) {
        paymentMethods = data.payment_methods;
        renderPaymentMethods();
    }).fail(function() {
        $('#paymentMethodsList').html('<p class="text-danger">加载支付方式失败</p>');
    });
}

// 渲染支付方式
function renderPaymentMethods() {
    const container = $('#paymentMethodsList');
    container.empty();
    
    if (paymentMethods.length === 0) {
        container.html('<p class="text-muted">此店铺未设置支付方式</p>');
        return;
    }
    
    paymentMethods.forEach(method => {
        const html = `
            <div class="payment-method-item mb-3 p-3 border rounded">
                <div class="form-check">
                    <input class="form-check-input payment-checkbox" 
                           type="checkbox" 
                           id="pm_${method.id}"
                           value="${method.id}"
                           data-code="${method.code}"
                           onchange="togglePaymentAmount(${method.id})">
                    <label class="form-check-label w-100" for="pm_${method.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="${method.icon} me-2 fs-5"></i>
                                <strong>${method.name}</strong>
                            </span>
                            <input type="number" 
                                   class="form-control form-control-sm payment-amount" 
                                   id="amount_${method.id}"
                                   data-method-id="${method.id}"
                                   min="0" 
                                   step="1"
                                   placeholder="输入金额"
                                   style="width: 140px; display: none;"
                                   onchange="calculatePaymentTotal()">
                        </div>
                    </label>
                </div>
            </div>
        `;
        container.append(html);
    });
}

// 切换支付方式金额输入框
function togglePaymentAmount(methodId) {
    const checkbox = $(`#pm_${methodId}`);
    const amountInput = $(`#amount_${methodId}`);
    
    if (checkbox.is(':checked')) {
        amountInput.show().focus();
    } else {
        amountInput.hide().val('');
        calculatePaymentTotal();
    }
}

// 计算支付总额
function calculatePaymentTotal() {
    let allocated = 0;
    $('.payment-amount:visible').each(function() {
        allocated += parseFloat($(this).val()) || 0;
    });
    
    $('#paymentAllocated').text(allocated.toFixed(2));
    
    // 验证
    const amountDue = parseFloat($('#amountDue').text());
    const error = $('#paymentError');
    
    if (allocated > 0 && Math.abs(allocated - amountDue) > 0.01) {
        error.html(`
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>支付金额不正确！</strong><br>
            应付：$${amountDue.toFixed(2)}，已分配：$${allocated.toFixed(2)}，
            差额：$${(amountDue - allocated).toFixed(2)}
        `).show();
        return false;
    } else {
        error.hide();
        return true;
    }
}

// 计算总额（含回馈金）
function calculateTotal() {
    // 计算订单总额
    let total = 0;
    for (const item of cartData) {
        total += item.unit_price * item.quantity;
    }
    
    $('#orderTotalCalc').text(total.toFixed(2));
    
    // 计算回馈金折扣
    const pointsToUse = parseInt($('#pointsToUse').val()) || 0;
    const pointsDiscount = pointsToUse;
    
    $('#pointsDiscount').text(pointsDiscount.toFixed(2));
    $('#pointsDiscountSummary').text('-$' + pointsDiscount.toFixed(2));
    
    // 计算应付金额
    const amountDue = Math.max(0, total - pointsDiscount);
    $('#amountDue').text(amountDue.toFixed(2));
    $('#orderTotal').text('$' + amountDue.toFixed(2));
    
    // 计算可赚取回馈金
    if (currentShopId && amountDue > 0) {
        $.post('/api/points/calculate', {
            order_total: amountDue,
            shop_id: currentShopId
        }, function(data) {
            $('#pointsToEarn').text(data.points_earned);
            $('#pointsToEarnSummary').text(data.points_earned);
        });
    } else {
        $('#pointsToEarn').text('0');
        $('#pointsToEarnSummary').text('0');
    }
    
    calculatePaymentTotal();
}

// 使用全部回馈金
function useAllPoints() {
    const total = parseFloat($('#orderTotalCalc').text());
    const maxPoints = Math.min({{ user.points }}, Math.floor(total));
    $('#pointsToUse').val(maxPoints);
    calculateTotal();
}

// 清除回馈金
function clearPoints() {
    $('#pointsToUse').val(0);
    calculateTotal();
}

// 获取支付分配
function getPaymentSplits() {
    const splits = [];
    $('.payment-checkbox:checked').each(function() {
        const methodId = parseInt($(this).val());
        const amount = parseFloat($(`#amount_${methodId}`).val()) || 0;
        
        if (amount > 0) {
            splits.push({
                payment_method_id: methodId,
                amount: amount
            });
        }
    });
    return splits;
}

// 顯示訂單商品
function displayOrderItems() {
    const container = document.getElementById('orderItems');
    let html = '';
    
    for (const item of cartData) {
        let toppingsHtml = '';
        if (item.toppings && item.toppings.length > 0) {
            const toppingNames = item.toppings.map(t => {
                return t.price > 0 ? `${t.name} (+$${t.price})` : `${t.name} (FREE)`;
            }).join('、');
            toppingsHtml = `<small class="text-muted d-block">配料：${toppingNames}</small>`;
        }
        
        // 显示饮品
        let drinkHtml = '';
        if (item.drink_type) {
            const drinkIcon = item.drink_type === 'cold' 
                ? '<i class="fa-solid fa-snowflake text-info"></i>' 
                : '<i class="fa-solid fa-mug-hot text-warning"></i>';
            const drinkName = item.drink_type === 'cold' ? '冷飲' : '熱飲';
            const drinkPriceText = item.drink_price > 0 ? ` (+$${item.drink_price})` : '';
            drinkHtml = `<small class="text-muted d-block">${drinkIcon} ${drinkName}${drinkPriceText}</small>`;
        }
        
        const itemTotal = item.unit_price * item.quantity;
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${item.product_name}</h6>
                    ${toppingsHtml}
                    ${drinkHtml}
                    <small class="text-muted">單價：$${item.unit_price} × ${item.quantity}</small>
                </div>
                <div class="text-end">
                    <strong class="text-primary">$${itemTotal.toFixed(2)}</strong>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// 更新訂單摘要
function updateOrderSummary() {
    let total = 0;
    for (const item of cartData) {
        total += item.unit_price * item.quantity;
    }
    
    document.getElementById('itemsCount').textContent = cartData.length + ' 件';
    document.getElementById('subtotal').textContent = '$' + total.toFixed(2);
    calculateTotal();
}

// 提交訂單
async function submitOrder() {
    // 驗證收貨信息
    const recipient_name = document.getElementById('recipient_name').value.trim();
    const recipient_phone = document.getElementById('recipient_phone').value.trim();
    const county = $('select[name="county"]').val();
    const district = $('select[name="district"]').val();
    const zipcode = $('input[name="zipcode"]').val();
    const recipient_address = document.getElementById('recipient_address').value.trim();
    
    if (!recipient_name || !recipient_phone || !county || !district || !zipcode || !recipient_address) {
        alert('請填寫完整的收貨信息');
        return;
    }
    
    // 验证组合支付
    if (!calculatePaymentTotal()) {
        alert('请正确分配支付金额');
        return;
    }
    
    const paymentSplits = getPaymentSplits();
    if (paymentSplits.length === 0) {
        alert('请选择至少一种支付方式');
        return;
    }
    
    const delivery_note = document.getElementById('delivery_note').value.trim();
    const pointsToUse = parseInt($('#pointsToUse').val()) || 0;
    
    // 準備訂單項目
    const items = cartData.map(item => ({
        product_id: item.product_id,
        quantity: item.quantity,
        drink_type: item.drink_type,
        toppings: item.toppings ? item.toppings.map(t => t.id) : []
    }));
    
    // 使用增强结账API
    try {
        const response = await fetch('/api/orders/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                shop_id: currentShopId,
                items: items,
                points_to_use: pointsToUse,
                payment_splits: paymentSplits,
                recipient_info: {
                    name: recipient_name,
                    phone: recipient_phone,
                    county: county,
                    district: district,
                    zipcode: zipcode,
                    address: recipient_address,
                    note: delivery_note
                }
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            alert('建立訂單失敗: ' + (error.error || '未知錯誤'));
            return;
        }
        
        const result = await response.json();
        
        // 清空購物車
        await fetch('/api/cart/clear', { method: 'DELETE' });
        
        // 更新徽章
        if (typeof updateCartCount === 'function') {
            updateCartCount();
        }
        
        // 显示详细信息
        alert(`訂單創建成功！\n\n` +
              `訂單編號：${result.order_number}\n` +
              `使用回饋金：${result.points_used} 点\n` +
              `獲得回饋金：${result.points_earned} 点\n` +
              `實付金額：$${result.amount_paid}`);
        
        window.location.href = '{{ url_for("customer.orders") }}';
        
    } catch (error) {
        console.error('提交訂單失敗:', error);
        alert('提交訂單失敗，請重試');
    }
}

// 頁面載入時載入數據
loadCheckoutData();
</script>
{% endblock %}

