{% extends "base/backend_base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">支付方式管理</h1>
        <a href="{{ url_for('backend.payment_method_add') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>新增支付方式
        </a>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 60px;">ID</th>
                            <th>名称</th>
                            <th>代码</th>
                            <th>图标</th>
                            <th>排序</th>
                            <th>状态</th>
                            <th style="width: 150px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="methodsTableBody">
                        <tr>
                            <td colspan="7" class="text-center text-muted">载入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
const paymentMethods = {{ payment_methods | tojson }};

$(document).ready(function() {
    loadMethods();
});

function loadMethods() {
    const tbody = $('#methodsTableBody');
    tbody.empty();
    
    if (paymentMethods.length === 0) {
        tbody.html('<tr><td colspan="7" class="text-center text-muted">暂无支付方式</td></tr>');
        return;
    }
    
    paymentMethods.forEach(method => {
        const row = renderMethodRow(method);
        tbody.append(row);
    });
}

function renderMethodRow(method) {
    const statusBadge = method.is_active 
        ? '<span class="badge bg-success">启用</span>' 
        : '<span class="badge bg-secondary">禁用</span>';
    
    const iconHtml = method.icon 
        ? `<i class="${method.icon}"></i>` 
        : '-';
    
    const deleteBtn = method.code === 'cash' 
        ? '<button class="btn btn-sm btn-outline-secondary" disabled title="现金支付不能删除"><i class="bi bi-trash"></i> 删除</button>'
        : `<button class="btn btn-sm btn-outline-danger" onclick="deleteMethod(${method.id})"><i class="bi bi-trash"></i> 删除</button>`;
    
    return `
        <tr>
            <td>${method.id}</td>
            <td>${method.name}</td>
            <td><code>${method.code}</code></td>
            <td>${iconHtml}</td>
            <td>${method.display_order}</td>
            <td>${statusBadge}</td>
            <td class="text-end">
                <a href="/backend/payment-methods/${method.id}/edit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i> 编辑
                </a>
                ${deleteBtn}
            </td>
        </tr>
    `;
}

function deleteMethod(methodId) {
    if (!confirm('确定要删除此支付方式吗？\n\n删除后将无法恢复，且已使用此支付方式的店铺设置将受影响。')) {
        return;
    }
    
    $.ajax({
        url: `/api/payment-methods/${methodId}`,
        method: 'DELETE',
        success: function(response) {
            alert(response.message);
            location.reload();
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || '删除失败';
            alert(error);
        }
    });
}
</script>
{% endblock %}

