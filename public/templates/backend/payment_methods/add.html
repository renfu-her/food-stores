{% extends "base/backend_base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">新增支付方式</h1>
        <a href="{{ url_for('backend.payment_methods') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>返回列表
        </a>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    基本资料
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="methodName" class="form-label">支付方式名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="methodName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="methodCode" class="form-label">代码 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="methodCode" required placeholder="例如：line_pay, jko_pay">
                        <small class="text-muted">只能包含小写字母、数字和下划线</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="methodIcon" class="form-label">图标 (Font Awesome)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="methodIcon" placeholder="例如：fa-brands fa-line">
                            <button class="btn btn-outline-secondary" type="button" onclick="testIcon()">
                                <i class="bi bi-eye"></i> 预览
                            </button>
                        </div>
                        <small class="text-muted">
                            <a href="https://fontawesome.com/search" target="_blank">查找图标</a>
                        </small>
                        <div id="iconPreview" class="mt-2" style="font-size: 2rem;"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="displayOrder" class="form-label">显示顺序</label>
                        <input type="number" class="form-control" id="displayOrder" value="0" min="0">
                        <small class="text-muted">数字越小越靠前（现金固定为99）</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            启用此支付方式
                        </label>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='{{ url_for('backend.payment_methods') }}'">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitForm()">
                        <i class="bi bi-check-lg me-2"></i>创建支付方式
                    </button>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">说明</div>
                <div class="card-body">
                    <h6>支付方式代码规则：</h6>
                    <ul class="small">
                        <li>只能包含小写字母、数字和下划线</li>
                        <li>必须唯一，不能重复</li>
                        <li>建议使用英文，如：<code>line_pay</code></li>
                    </ul>
                    
                    <h6 class="mt-3">常用图标：</h6>
                    <ul class="small">
                        <li><i class="fa-brands fa-line"></i> LINE Pay: <code>fa-brands fa-line</code></li>
                        <li><i class="fa-solid fa-wallet"></i> 街口: <code>fa-solid fa-wallet</code></li>
                        <li><i class="fa-solid fa-money-bill-1"></i> 现金: <code>fa-solid fa-money-bill-1</code></li>
                        <li><i class="fa-brands fa-cc-visa"></i> 信用卡: <code>fa-brands fa-cc-visa</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
function testIcon() {
    const icon = $('#methodIcon').val();
    if (icon) {
        $('#iconPreview').html(`<i class="${icon}"></i>`);
    } else {
        $('#iconPreview').html('');
    }
}

function submitForm() {
    const name = $('#methodName').val().trim();
    const code = $('#methodCode').val().trim();
    const icon = $('#methodIcon').val().trim();
    const displayOrder = parseInt($('#displayOrder').val()) || 0;
    const isActive = $('#isActive').is(':checked');
    
    if (!name || !code) {
        alert('请填写所有必填字段');
        return;
    }
    
    // 验证代码格式
    if (!/^[a-z0-9_]+$/.test(code)) {
        alert('代码只能包含小写字母、数字和下划线');
        return;
    }
    
    const data = {
        name: name,
        code: code,
        icon: icon,
        display_order: displayOrder,
        is_active: isActive
    };
    
    $.ajax({
        url: '/api/payment-methods',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            alert(response.message);
            window.location.href = '{{ url_for('backend.payment_methods') }}';
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || '创建失败';
            alert(error);
        }
    });
}
</script>
{% endblock %}

